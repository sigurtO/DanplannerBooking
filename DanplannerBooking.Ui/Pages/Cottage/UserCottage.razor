@page "/user-cottages"
@using DanplannerBooking.Application.Dtos.Cottage
@inject HttpClient Http
@inject NavigationManager NavigationManager

<h3>UserCottage</h3>

<h3>Available Cottages</h3>

@if (cottages == null)
{
 <p>Loading cottages...</p>
}
else if (cottages.Count ==0)
{
 <p>No cottages found.</p>
}
else
{
 <div class="row">
 @foreach (var cottage in cottages)
 {
 <div class="col-md-6 mb-4">
 <div class="card shadow-sm">
 <div class="row g-0">
 <div class="col-md-4">
 @if (cottage.Image != null && cottage.Image.Length >0)
 {
 <img class="card-img-top"
 src="@($"data:image/png;base64,{Convert.ToBase64String(cottage.Image)}")"
 alt="Apartment Image"
 style="height:200px; object-fit:cover;" />
 }
 else
 {
 <div class="card-img-top text-center p-5 bg-light text-muted">
 No Image
 </div>
 }
 </div>
 <div class="col-md-8">
 <div class="card-body">
 <h5 class="card-title">@cottage.Name</h5>
 <p class="card-text">
 <strong>Location:</strong> @cottage.Location<br />
 <strong>Description:</strong> @cottage.Description<br />
 <strong>Price:</strong> @cottage.PricePerNight.ToString("C")<br />
 <strong>Availability:</strong> @(cottage.IsAvailable ? "✅ Available" : "❌ Unavailable")<br />
 <strong>Features:</strong><br />
 🚽 Toilet: @(cottage.HasToilet ? "Yes" : "No")<br />
 🚿 Shower: @(cottage.HasShower ? "Yes" : "No")<br />
 🍳 Kitchen: @(cottage.HasKitchen ? "Yes" : "No")<br />
 🔥 Heating: @(cottage.HasHeating ? "Yes" : "No")<br />
 📶 WiFi: @(cottage.HasWiFi ? "Yes" : "No")
 </p>
 <button class="btn btn-primary" @onclick="() => NavigateToDetails(cottage.Id)">View Details</button>
 </div>
 </div>
 </div>
 </div>
 </div>
 }
 </div>
}

@code {
 private List<CottageResponseDto> cottages = new();

 protected override async Task OnInitializedAsync()
 {
 var all = await Http.GetFromJsonAsync<List<CottageResponseDto>>("api/cottage") ?? new List<CottageResponseDto>();
 var campsiteIdString = GetQueryParam(NavigationManager.Uri, "campsiteId");
 if (!string.IsNullOrEmpty(campsiteIdString) && Guid.TryParse(campsiteIdString, out var campsiteGuid))
 {
 cottages = all.Where(c => c.CampsiteId == campsiteGuid).ToList();
 }
 else
 {
 cottages = all;
 }
 }

 private void NavigateToDetails(Guid cottageId)
 {
 // Navigate to user-facing booking page for the selected cottage
 NavigationManager.NavigateTo($"/user-book-cottage/{cottageId}");
 }

 private static string? GetQueryParam(string uri, string param)
 {
 if (string.IsNullOrEmpty(uri)) return null;
 var q = new Uri(uri).Query;
 if (string.IsNullOrEmpty(q)) return null;
 var pairs = q.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries);
 foreach (var p in pairs)
 {
 var kv = p.Split('=',2);
 if (kv.Length >=1)
 {
 var key = Uri.UnescapeDataString(kv[0]);
 if (string.Equals(key, param, StringComparison.OrdinalIgnoreCase))
 {
 var value = kv.Length ==2 ? Uri.UnescapeDataString(kv[1]) : string.Empty;
 return value;
 }
 }
 }
 return null;
 }
}
