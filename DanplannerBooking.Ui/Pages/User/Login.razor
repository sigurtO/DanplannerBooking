@page "/login"
@using DanplannerBooking.Application.Dtos.User
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthProvider

<h3>Login</h3>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card p-3" style="max-width:400px;">
    <input class="form-control mb-2" placeholder="Email" @bind="login.Email" />
    <input class="form-control mb-2" type="password" placeholder="Password" @bind="login.Password" />

    <button class="btn btn-primary w-100" @onclick="HandleLogin">Login</button>
</div>
<style>
    .p-3{
        border: none;
        display: flex;
        justify-content: center;
        align-items: center;
        margin:0 auto;
        margin-top:100px;
    }
</style>

@code {
    private LoginRequestDto login = new();
    private string? errorMessage;
    private string? returnUrl;

    protected override void OnInitialized()
    {
        returnUrl = GetQueryParam(Nav.Uri, "returnUrl");
    }

    private async Task HandleLogin()
    {
        errorMessage = null;

        var response = await Http.PostAsJsonAsync("api/auth/login", login);

        if (!response.IsSuccessStatusCode)
        {
            errorMessage = "Invalid email or password.";
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<LoginResponseDto>();

        var jwtProvider = (JwtAuthenticationStateProvider)AuthProvider;
        await jwtProvider.MarkUserAsAuthenticated(result.Token);

        // Redirect to returnUrl if present, else based on role
        if (!string.IsNullOrWhiteSpace(returnUrl))
        {
            Nav.NavigateTo(returnUrl);
            return;
        }

        if (result.Role == "Admin")
            Nav.NavigateTo("/AdminDashboard");
        else
            Nav.NavigateTo("/"); // booking side kommer senere
    }

    private static string? GetQueryParam(string uri, string param)
    {
        if (string.IsNullOrEmpty(uri)) return null;
        var q = new Uri(uri).Query;
        if (string.IsNullOrEmpty(q)) return null;
        var pairs = q.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var p in pairs)
        {
            var kv = p.Split('=',2);
            if (kv.Length >=1)
            {
                var key = Uri.UnescapeDataString(kv[0]);
                if (string.Equals(key, param, StringComparison.OrdinalIgnoreCase))
                {
                    var value = kv.Length ==2 ? Uri.UnescapeDataString(kv[1]) : string.Empty;
                    return value;
                }
            }
        }
        return null;
    }
}

@{ 
    // link to register preserving returnUrl
    var regLink = "/register" + (string.IsNullOrWhiteSpace(returnUrl) ? "" : $"?returnUrl={Uri.EscapeDataString(returnUrl)}");
}
<a href="@regLink"> Don't have an account? Register here.</a>
