@page "/users"
@using Microsoft.AspNetCore.Authorization
@using DanplannerBooking.Application.Dtos.User

@attribute [Authorize(Roles = "Admin")]

@inject HttpClient Http
@inject NavigationManager Nav

<AuthorizeView Roles="Admin">
    <Authorized Context="adminContent">


        <h3>All Users</h3>

        @if (users == null)
        {
            <p>Loading users...</p>
        }
        else if (users.Count == 0)
        {
            <p>No users found.</p>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Account Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>@user.Name</td>
                            <td>@user.Email</td>
                            <td>@(user.Role == "Admin" ? "Admin" : "User")</td>
                            <td>
                                <button class="btn btn-warning btn-sm" @onclick="() => EditUser(user)">Update</button>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteUser(user.Id)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (editUser != null)
        {
            <h4>Edit User</h4>
            <EditForm Model="@editUser" OnValidSubmit="HandleUpdate">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-2">
                    <label>Name:</label>
                    <InputText @bind-Value="editUser.Name" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Email:</label>
                    <InputText @bind-Value="editUser.Email" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Phone:</label>
                    <InputText @bind-Value="editUser.Phone" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Country:</label>
                    <InputText @bind-Value="editUser.Country" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Language:</label>
                    <InputText @bind-Value="editUser.Language" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Role:</label>
                    <InputSelect @bind-Value="editUser.Role" class="form-control">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </InputSelect>
                </div>

                <button type="submit" class="btn btn-success">Save Changes</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CancelEdit">Cancel</button>
            </EditForm>
        }

    </Authorized>

    <NotAuthorized>
        @code {
            [Inject] NavigationManager RedirectNav { get; set; }

            protected override void OnInitialized()
            {
                // non-admin → force redirect
                RedirectNav.NavigateTo("/login", true);
            }
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<UserResponseDto> users;
    private AdminUpdateUserDto editUser;
    private Guid editingUserId;

    protected override async Task OnInitializedAsync()
    {
        users = await Http.GetFromJsonAsync<List<UserResponseDto>>("api/user");
    }

    private async Task DeleteUser(Guid userId)
    {
        var response = await Http.DeleteAsync($"api/user/{userId}");
        if (response.IsSuccessStatusCode)
        {
            users = users.Where(u => u.Id != userId).ToList();
        }
    }

    private void EditUser(UserResponseDto user)
    {
        editingUserId = user.Id;
        editUser = new AdminUpdateUserDto
        {
            Name = user.Name,
            Email = user.Email,
            Phone = user.Phone,
            Country = user.Country,
            Language = user.Language,
            Role = user.Role
        };
    }

    private async Task HandleUpdate()
    {
        var response = await Http.PutAsJsonAsync($"api/user/{editingUserId}", editUser);

        if (response.IsSuccessStatusCode)
        {
            var index = users.FindIndex(u => u.Id == editingUserId);

            if (index != -1)
            {
                users[index] = new UserResponseDto(
                    editingUserId,
                    editUser.Name,
                    editUser.Email,
                    editUser.Phone,
                    editUser.Country,
                    editUser.Language,
                    editUser.Role
                );
            }

            editUser = null;
        }
    }

    private void CancelEdit()
    {
        editUser = null;
    }
}
