@page "/AdminDashboard"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq
@using DanplannerBooking.Application.Dtos.Booking
@using DanplannerBooking.Application.Dtos.AddOn
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject HttpClient Http

<h3 class="mb-4">Admin Dashboard</h3>

<AuthorizeView Roles="Admin">

    <Authorized>
        @if (role == null)
        {
            <p>Loader...</p>
        }
        else
        {
            <!-- TOP STATS -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm p-3 border-0" style="background:#e8f8e8;">
                        <h5 class="card-title text-success">Ankomster i dag</h5>
                        <h1 class="text-success fw-bold">@((arrivals?.Count ?? 0))</h1>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm p-3 border-0" style="background:#fdeaea;">
                        <h5 class="card-title text-danger">Afrejser i dag</h5>
                        <h1 class="text-danger fw-bold">@((departures?.Count ?? 0))</h1>
                    </div>
                </div>
            </div>

            <!-- ARRIVALS LIST -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="m-0">Ankomster i dag</h5>
                </div>
                <div class="card-body">
                    @if (arrivals == null)
                    {
                        <p>Loader...</p>
                    }
                    else if (!arrivals.Any())
                    {
                        <p>Ingen ankomster i dag.</p>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var b in arrivals)
                            {
                                <li class="list-group-item list-group-item-action d-flex justify-content-between @(selectedBooking != null && selectedBooking.Id == b.Id ? "active" : "")"
                                    style="cursor:pointer;"
                                    @onclick="() => SelectBooking(b.Id)">
                                    <span>
                                        <strong>@b.Name</strong><br />
                                        <small>Starter: @b.DateStart.ToShortDateString()</small>
                                    </span>

                                    <span class="badge bg-success">Kommer i dag</span>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <!-- DEPARTURES LIST -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="m-0">Afrejser i dag</h5>
                </div>
                <div class="card-body">
                    @if (departures == null)
                    {
                        <p>Loader...</p>
                    }
                    else if (!departures.Any())
                    {
                        <p>Ingen afrejser i dag.</p>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var b in departures)
                            {
                                <li class="list-group-item list-group-item-action d-flex justify-content-between @(selectedBooking != null && selectedBooking.Id == b.Id ? "active" : "")"
                                    style="cursor:pointer;"
                                    @onclick="() => SelectBooking(b.Id)">
                                    <span>
                                        <strong>@b.Name</strong><br />
                                        <small>Slutter: @b.DateEnd.ToShortDateString()</small>
                                    </span>

                                    <span class="badge bg-danger">Rejser i dag</span>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <!-- BOOKING DETALJER NEDENUNDER -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="m-0">Booking detaljer</h5>
                </div>
                <div class="card-body">
                    @if (isBookingDetailsLoading)
                    {
                        <p>Henter booking-detaljer...</p>
                    }
                    else if (!string.IsNullOrEmpty(bookingDetailsError))
                    {
                        <div class="alert alert-danger">@bookingDetailsError</div>
                    }
                    else if (selectedBooking == null)
                    {
                        <p>Klik på en booking ovenfor for at se detaljer.</p>
                    }
                    else
                    {
                        <dl class="row">
                            <dt class="col-sm-3">Navn</dt>
                            <dd class="col-sm-9">@selectedBooking.Name</dd>

                            <dt class="col-sm-3">Bruger</dt>
                            <dd class="col-sm-9">
                                @if (selectedBooking.User != null)
                                {
                                    @selectedBooking.User.Name @(" (")@selectedBooking.User.Email@(")")
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </dd>

                            <dt class="col-sm-3">Gæster</dt>
                            <dd class="col-sm-9">@selectedBooking.NumberOfPeople</dd>

                            <dt class="col-sm-3">Ankomst</dt>
                            <dd class="col-sm-9">
                                @selectedBooking.DateStart.ToString("dd.MM.yyyy HH:mm")
                            </dd>

                            <dt class="col-sm-3">Afrejse</dt>
                            <dd class="col-sm-9">
                                @selectedBooking.DateEnd.ToString("dd.MM.yyyy HH:mm")
                            </dd>

                            <dt class="col-sm-3">Enhed</dt>
                            <dd class="col-sm-9">
                                @if (selectedBooking.Cottage != null)
                                {
                                    <span>Hytte: @selectedBooking.Cottage.Name</span>
                                }
                                else if (selectedBooking.Space != null)
                                {
                                    <span>Plads: @selectedBooking.Space.Name</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </dd>

                            <dt class="col-sm-3">Add-ons</dt>
                            <dd class="col-sm-9">
                                @if (SelectedAddOns.Any())
                                {
                                    <ul class="mb-0">
                                        @foreach (var addon in SelectedAddOns)
                                        {
                                            <li>@addon.Name (@addon.Price.ToString("C"))</li>
                                        }
                                    </ul>
                                }
                                else if (selectedBooking.AddOnIds != null && selectedBooking.AddOnIds.Any())
                                {
                                    <span>@selectedBooking.AddOnIds.Count @(" tilkøb (navne kunne ikke indlæses)")</span>
                                }
                                else
                                {
                                    <span>Ingen tilkøb</span>
                                }
                            </dd>
                        </dl>
                    }
                </div>
            </div>

            <!-- ADMIN NAVIGATION -->
            <div class="card shadow-sm p-3">
                <h5 class="mb-3">Administration</h5>

                <div class="row row-cols-1 row-cols-md-3 g-3">
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/users">Brugere</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/spaces-admin">Pladser</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/cottages-admin">Hytter</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Space">Opret plads</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Cottage">Opret hytte</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Addon">Opret tilkøb</a>
                    </div>
                </div>
            </div>
        }
    </Authorized>

    <NotAuthorized>
        <p>Du er ikke logget ind som administrator.</p>
        <button class="btn btn-primary" @onclick="GoToLogin">Login</button>
    </NotAuthorized>
</AuthorizeView>


@code {
    private string? role;

    private List<BookingDashboardDto>? arrivals;
    private List<BookingDashboardDto>? departures;

    private BookingResponseDto? selectedBooking;
    private bool isBookingDetailsLoading;
    private string? bookingDetailsError;

    private List<AddOnResponseDto> addOns = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // (valgfrit) du må godt beholde dette hvis du bruger 'role' i dit UI:
        role = user.FindFirst(ClaimTypes.Role)?.Value
            ?? user.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role")?.Value;

        // Load dashboard data
        arrivals = await Http.GetFromJsonAsync<List<BookingDashboardDto>>("api/booking/arrivals-today");
        departures = await Http.GetFromJsonAsync<List<BookingDashboardDto>>("api/booking/departures-today");

        // Load alle add-ons til brug i detaljevisning
        addOns = await Http.GetFromJsonAsync<List<AddOnResponseDto>>("api/addon") ?? new();
    }

    private async Task SelectBooking(Guid bookingId)
    {
        isBookingDetailsLoading = true;
        bookingDetailsError = null;

        try
        {
            // Første forsøg: detalje-endpoint
            selectedBooking = await Http.GetFromJsonAsync<BookingResponseDto>($"api/booking/{bookingId}");

            var needsFallback = selectedBooking == null
                                || selectedBooking.AddOnIds == null
                                || !selectedBooking.AddOnIds.Any();

            if (needsFallback)
            {
                var allBookings = await Http.GetFromJsonAsync<List<BookingResponseDto>>("api/booking")
                                 ?? new List<BookingResponseDto>();

                var fromList = allBookings.FirstOrDefault(b => b.Id == bookingId);
                if (fromList != null)
                {
                    selectedBooking = fromList;
                }
            }
        }
        catch (Exception ex)
        {
            bookingDetailsError = $"Kunne ikke hente booking-detaljer: {ex.Message}";
            selectedBooking = null;
        }
        finally
        {
            isBookingDetailsLoading = false;
        }
    }

    private IEnumerable<AddOnResponseDto> SelectedAddOns =>
        selectedBooking?.AddOnIds == null
            ? Enumerable.Empty<AddOnResponseDto>()
            : addOns.Where(a => selectedBooking.AddOnIds.Contains(a.Id));

    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
}
