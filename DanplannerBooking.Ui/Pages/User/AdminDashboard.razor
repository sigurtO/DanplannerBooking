@page "/AdminDashboard"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]


@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using DanplannerBooking.Application.Dtos.Booking
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject HttpClient Http

<h3 class="mb-4">Admin Dashboard</h3>

<AuthorizeView Roles="Admin">

    <Authorized>
        @if (role == null)
        {
            <p>Loader...</p>
        }
        else
        {
            <!-- TOP STATS -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm p-3 border-0" style="background:#e8f8e8;">
                        <h5 class="card-title text-success">Ankomster i dag</h5>
                        <h1 class="text-success fw-bold">@((arrivals?.Count ?? 0))</h1>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm p-3 border-0" style="background:#fdeaea;">
                        <h5 class="card-title text-danger">Afrejser i dag</h5>
                        <h1 class="text-danger fw-bold">@((departures?.Count ?? 0))</h1>
                    </div>
                </div>
            </div>

            <!-- ARRIVALS LIST -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="m-0">Ankomster i dag</h5>
                </div>
                <div class="card-body">
                    @if (arrivals == null)
                    {
                        <p>Loader...</p>
                    }
                    else if (!arrivals.Any())
                    {
                        <p>Ingen ankomster i dag.</p>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var b in arrivals)
                            {
                                var isMarked = IsArrivalMarked(b.Id);

                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <strong>@b.Name</strong><br />
                                        <small>Starter: @b.DateStart.ToShortDateString()</small>
                                    </span>

                                    <div class="d-flex flex-column align-items-end">
                                        <span class="badge @(isMarked ? "bg-secondary" : "bg-success") mb-1">
                                            @(isMarked ? "Ankommet" : "Kommer i dag")
                                        </span>
                                        <button class="btn btn-sm @(isMarked ? "btn-secondary" : "btn-outline-success")"
                                                disabled="@isMarked"
                                                @onclick="() => MarkArrival(b.Id)">
                                            @(isMarked ? "Markeret" : "Marker ankommet")
                                        </button>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <!-- DEPARTURES LIST -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="m-0">Afrejser i dag</h5>
                </div>
                <div class="card-body">
                    @if (departures == null)
                    {
                        <p>Loader...</p>
                    }
                    else if (!departures.Any())
                    {
                        <p>Ingen afrejser i dag.</p>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var b in departures)
                            {
                                var isMarked = IsDepartureMarked(b.Id);

                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <strong>@b.Name</strong><br />
                                        <small>Slutter: @b.DateEnd.ToShortDateString()</small>
                                    </span>

                                    <div class="d-flex flex-column align-items-end">
                                        <span class="badge @(isMarked ? "bg-secondary" : "bg-danger") mb-1">
                                            @(isMarked ? "Rejst" : "Rejser i dag")
                                        </span>
                                        <button class="btn btn-sm @(isMarked ? "btn-secondary" : "btn-outline-danger")"
                                                disabled="@isMarked"
                                                @onclick="() => MarkDeparture(b.Id)">
                                            @(isMarked ? "Markeret" : "Marker rejst")
                                        </button>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <!-- ADMIN NAVIGATION -->
            <div class="card shadow-sm p-3">
                <h5 class="mb-3">Administration</h5>

                <div class="row row-cols-1 row-cols-md-3 g-3">
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/users">Brugere</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/allSpaces">Pladser</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-primary w-100" href="/allCottages">Hytter</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Space">Opret plads</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Cottage">Opret hytte</a>
                    </div>
                    <div class="col">
                        <a class="btn btn-outline-success w-100" href="/create-Addon">Opret tilkøb</a>
                    </div>
                </div>
            </div>
        }
    </Authorized>

    <NotAuthorized>
        <p>Du er ikke logget ind som administrator.</p>
        <button class="btn btn-primary" @onclick="GoToLogin">Login</button>
    </NotAuthorized>
</AuthorizeView>


@code {
    private string? role;

    private List<BookingDashboardDto>? arrivals;
    private List<BookingDashboardDto>? departures;

    // UI-status for “ankommet” / “rejst” (ikke i databasen)
    private HashSet<Guid> arrivalsMarked = new();
    private HashSet<Guid> departuresMarked = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // (valgfrit) du må godt beholde dette hvis du bruger 'role' i dit UI:
        role = user.FindFirst(ClaimTypes.Role)?.Value
            ?? user.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role")?.Value;

        // Load dashboard data
        arrivals = await Http.GetFromJsonAsync<List<BookingDashboardDto>>("api/booking/arrivals-today");
        departures = await Http.GetFromJsonAsync<List<BookingDashboardDto>>("api/booking/departures-today");
    }

    private bool IsArrivalMarked(Guid id) => arrivalsMarked.Contains(id);
    private bool IsDepartureMarked(Guid id) => departuresMarked.Contains(id);

    private void MarkArrival(Guid id)
    {
        arrivalsMarked.Add(id);
    }

    private void MarkDeparture(Guid id)
    {
        departuresMarked.Add(id);
    }

    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
}
