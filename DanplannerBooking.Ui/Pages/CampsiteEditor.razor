@page "/editor"
@using System.Text.Json
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS
@inject HttpClient Http

<h2>🗺️ Kort-editor</h2>
<p class="text-muted">Vælg campingplads, importer/opret enheder, træk markører, og gem layout.</p>

<div class="mb-3" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
    <div style="min-width:320px; max-width:420px">
        <label class="form-label">Vælg campingplads</label>
        <select class="form-select"
                @bind="SelectedCampsiteId"
                @bind:after="OnCampsiteChanged">
            @if (Campsites.Count == 0)
            {
                <option value="">(indlæser…)</option>
            }
            else
            {
                <option value="">— vælg —</option>
                @foreach (var c in Campsites)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            }
        </select>

        @if (SelectedCampsite is not null)
        {
            <div class="mt-2 card" style="padding:8px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="width:72px; height:48px; overflow:hidden; border-radius:6px; border:1px solid #ddd;">
                        <img src="@BgImageUrl" alt="Campsite preview" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                    <div>
                        <div><strong>@SelectedCampsite.Name</strong></div>
                        <div class="text-muted" style="font-size:.85rem;">Billedsti: <code>@BgImageUrl</code></div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="alert alert-info mt-4" style="flex:1;min-width:280px;">
        Træk markører for at flytte dem. Brug “Placer markør på kort” for at give DB-enheder en placering.
    </div>
</div>

<div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
    <div class="card" style="min-width:280px; max-width:360px; padding:12px;">
        <h3>Værktøjer</h3>
        <p class="text-muted" style="font-size:.9rem;">
            Tilføj nye enheder (kun i UI), eller placer eksisterende DB-enheder på kortet.
        </p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
            <button class="btn btn-primary" @onclick="AddTent" disabled="@DisabledNoCampsite">+ Teltplads</button>
            <button class="btn btn-primary" @onclick="AddCabin" disabled="@DisabledNoCampsite">+ Hytte</button>
        </div>

        @if (Selected is not null)
        {
            <hr />
            <h4>Valgt</h4>
            <label>Navn</label>
            <input class="form-control" @bind="Selected.Name" />
            <label class="mt-2">Type</label>
            <select class="form-select" @bind="Selected.ProductType">
                <option value="Plads">Plads</option>
                <option value="Hytte">Hytte</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" class="mt-2">
                <div><label>X</label><input class="form-control" type="number" @bind="Selected.X" /></div>
                <div><label>Y</label><input class="form-control" type="number" @bind="Selected.Y" /></div>
            </div>
            <div class="mt-2" style="display:flex; gap:8px;">
                <button class="btn btn-outline-secondary" @onclick="ApplyManualPosition">↻ Opdater</button>
                <button class="btn btn-outline-danger" @onclick="DeleteSelected">🗑️ Slet</button>
            </div>

            @if (SelectedBookings is not null && SelectedBookings.Count > 0)
            {
                <div class="mt-3">
                    <h5>Bookinger</h5>
                    <ul class="list-unstyled">
                        @foreach (var b in SelectedBookings)
                        {
                            <li class="mb-1">
                                <strong>@b.DateStart.ToString("dd-MM-yyyy") - @b.DateEnd.ToString("dd-MM-yyyy")</strong><br />
                                @b.UserName (@b.NumberOfPeople personer) – @b.TotalPrice.ToString("C")
                            </li>
                        }
                    </ul>
                </div>
            }
            else
            {
                <p class="mt-2 text-muted">Ingen bookinger for denne enhed.</p>
            }
        }

        <hr />
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn btn-outline-primary" @onclick="ExportJson" disabled="@DisabledNoCampsite">⬇️ Export</button>

            <label class="btn btn-outline-secondary" style="margin:0;">
                ⬆️ Import
                <InputFile OnChange="ImportJson" accept=".json,.txt,application/json" class="ms-2" />
            </label>

            <button class="btn btn-outline-warning" @onclick="CreateNewInDb" disabled="@DisabledNoNew">
                Opret nye i DB
            </button>

            <button class="btn btn-success" @onclick="SaveLayout" disabled="@DisabledNoDb">
                Gem layout
            </button>
        </div>

        <hr />
        <h5>Placer DB-enhed</h5>
        <select class="form-select" @bind="SelectedOptionId">
            <option value="">— vælg enhed (uden placering) —</option>
            @foreach (var o in Options)
            {
                <option value="@o.Id">@o.Name (@(o.Type == "Cottage" ? "Hytte" : "Plads"))</option>
            }
        </select>
        <div class="mt-2" style="display:flex; gap:8px;">
            <button class="btn btn-outline-secondary" @onclick="LoadOptions">Opdater liste</button>
            <button class="btn btn-primary" type="button" @onclick="StartPlaceOnMap" disabled="@string.IsNullOrEmpty(SelectedOptionId)">
                Placer markør på kort
            </button>
        </div>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="alert mt-2 py-2" style="border-radius:6px; font-size:0.9rem;
                 @(StatusKind == "success" ? "background:#e6ffed;border:1px solid #a3e6b1;color:#116130;" :
                   StatusKind == "danger"  ? "background:#ffe6e6;border:1px solid #f5a3a3;color:#7f1111;" :
                   StatusKind == "warning" ? "background:#fff8e6;border:1px solid #f2d38b;color:#7a5b00;" :
                                              "background:#eef4ff;border:1px solid #c8d9ff;color:#0b3d91;" )">
                @StatusMessage
            </div>
        }
    </div>

    <div id="mapContainer" style="flex:1 1 820px; min-width:760px; height:560px; border:1px solid #ccc; border-radius:10px; overflow:hidden;">
        <svg id="campsiteSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1336 768" style="width:100%; height:100%;">
            <image href="@BgImageUrl" x="0" y="0" width="1336" height="768" />
            @foreach (var u in Units)
            {
                var isSel = _selectedId == u.Id;
                var border = isSel ? "stroke-width:3; stroke:#fff" : "stroke-width:2; stroke:#fff";
                <g class="unit @(u.ProductType == "Hytte" ? "hut" : "tent")"
                   data-id="@u.Id"
                   transform="translate(@u.X,@u.Y)"
                   @onclick="() => OnUnitClicked(u)">
                    @if (u.ProductType == "Hytte")
                    {
                        <rect x="-16" y="-12" rx="5" ry="5" width="32" height="24" style="fill:rgba(0,0,255,.55); @border"></rect>
                        <path d="M-18 -12 L0 -26 L18 -12" style="fill:#0039b3; opacity:.85"></path>
                    }
                    else
                    {
                        <circle r="12" style="fill:rgba(0,200,0,.6); @border"></circle>
                    }
                    <text y="-20" text-anchor="middle" fill="white" font-size="12">
                        @u.Name @if(!u.FromDb){
                        <tspan fill="#ffd54f"> (ny)</tspan>
                    }
                    </text>
                </g>
            }
        </svg>
    </div>
</div>

@code {
    // ---------- Campsites ----------
    private sealed class UiCampsite
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string ImageUrl { get; set; } = "";
    }
    private List<UiCampsite> Campsites = new();
    private string? SelectedCampsiteId;
    private UiCampsite? SelectedCampsite => Campsites.FirstOrDefault(c => c.Id == SelectedCampsiteId);
    private string BgImageUrl => string.IsNullOrWhiteSpace(SelectedCampsite?.ImageUrl) ? "images/campsite.jpg" : SelectedCampsite!.ImageUrl;

    private bool DisabledNoCampsite => string.IsNullOrEmpty(SelectedCampsiteId);
    private bool DisabledNoNew => DisabledNoCampsite || !Units.Any(u => !u.FromDb);
    private bool DisabledNoDb => DisabledNoCampsite || !Units.Any(u => u.FromDb);

    // ---------- Status ----------
    private string? StatusMessage;
    private string StatusKind = "info";

    // ---------- Units ----------
    public record EditableUnit
    {
        public string Id { get; init; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = "Plads";
        public string ProductType { get; set; } = "Plads"; // "Plads" | "Hytte"
        public int X { get; set; }
        public int Y { get; set; }
        public bool FromDb { get; set; } = false;
    }
    private List<EditableUnit> Units = new();
    private string? _selectedId;
    private EditableUnit? Selected => Units.FirstOrDefault(z => z.Id == _selectedId);

    // ---------- Bookings for selected unit ----------
    private sealed class BookingSummary
    {
        public Guid Id { get; set; }
        public DateTime DateStart { get; set; }
        public DateTime DateEnd { get; set; }
        public string UserName { get; set; } = "";
        public int NumberOfPeople { get; set; }
        public decimal TotalPrice { get; set; }
    }

    private List<BookingSummary> SelectedBookings { get; set; } = new();

    // ---------- Options ----------
    private sealed class UnitOption
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";   // "Space" | "Cottage"
        public bool HasPosition { get; set; }
        public string CampsiteId { get; set; } = "";
    }
    private List<UnitOption> Options = new();
    private string? SelectedOptionId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
            await JS.InvokeVoidAsync("CampsiteMap.enableDrag", "#campsiteSvg", "g.unit", DotNetObjectReference.Create(this));
            await LoadCampsites();
        }
    }

    private async Task LoadCampsites()
    {
        try
        {
            var data = await Http.GetFromJsonAsync<List<CampsiteDto>>("api/campsites") ?? new();
            Campsites = data.Select(c => new UiCampsite
            {
                Id = c.Id.ToString(),
                Name = c.Name,
                ImageUrl = string.IsNullOrWhiteSpace(c.ImageUrl) ? "images/campsite.jpg" : c.ImageUrl
            }).ToList();
        }
        catch
        {
            Campsites = new();
        }

        if (string.IsNullOrEmpty(SelectedCampsiteId) && Campsites.Count > 0)
            SelectedCampsiteId = Campsites[0].Id;

        await RefreshForCampsite();
        StateHasChanged();
    }

    private async Task OnCampsiteChanged() => await RefreshForCampsite();

    private async Task RefreshForCampsite()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId))
        {
            Units.Clear(); Options.Clear(); StateHasChanged(); return;
        }
        await LoadFromApi();
        await LoadOptions();
    }

    private async Task OnUnitClicked(EditableUnit u)
    {
        _selectedId = u.Id;
        SelectedBookings = new List<BookingSummary>();

        // hvis enheden ikke er fra DB endnu, giver det ingen mening at hente bookinger
        if (!u.FromDb)
        {
            StatusKind = "info";
            StatusMessage = "Enheden er ikke oprettet i databasen endnu, så der findes ingen bookinger.";
            StateHasChanged();
            return;
        }

        try
        {
            var type = u.ProductType == "Hytte" ? "Cottage" : "Space";
            var url = $"api/booking/by-unit/{u.Id}?type={type}";

            var data = await Http.GetFromJsonAsync<List<BookingSummary>>(url) ?? new();
            SelectedBookings = data;

            if (SelectedBookings.Count == 0)
            {
                StatusKind = "info";
                StatusMessage = "Ingen bookinger fundet for denne enhed.";
            }
            else
            {
                StatusKind = "info";
                StatusMessage = $"Indlæst {SelectedBookings.Count} bookinger for enheden.";
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Kunne ikke hente bookinger: " + ex.Message;
        }

        StateHasChanged();
    }

    [JSInvokable]
    public Task OnMarkerMoved(string id, int x, int y)
    {
        var u = Units.FirstOrDefault(z => z.Id == id);
        if (u is not null) { u.X = x; u.Y = y; StateHasChanged(); }
        return Task.CompletedTask;
    }

    private void AddTent()
    {
        var idx = Units.Count(u => u.ProductType == "Plads") + 101;
        Units.Add(new EditableUnit { Name = $"P-{idx}", ProductType = "Plads", X = 200, Y = 200, FromDb = false });
    }

    private void AddCabin()
    {
        var idx = Units.Count(u => u.ProductType == "Hytte") + 201;
        Units.Add(new EditableUnit { Name = $"H-{idx}", ProductType = "Hytte", X = 230, Y = 230, FromDb = false });
    }

    private void DeleteSelected()
    {
        if (_selectedId is null) return;
        Units = Units.Where(u => u.Id != _selectedId).ToList();
        _selectedId = null;
        SelectedBookings.Clear();
    }

    private void ApplyManualPosition() => StateHasChanged();

    private async Task ExportJson()
    {
        var json = JsonSerializer.Serialize(Units, new JsonSerializerOptions { WriteIndented = true });
        await JS.InvokeVoidAsync("CampsiteMap.downloadText", "campsite-layout.json", json);
    }

    private async Task ImportJson(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        using var stream = file.OpenReadStream(maxAllowedSize: 1_048_576);
        using var reader = new StreamReader(stream);
        var text = await reader.ReadToEndAsync();

        var payload = text.TrimStart().StartsWith("{")
            ? text
            : $"{{\"createMissing\":true,\"units\":{text}}}";

        var content = new StringContent(payload, System.Text.Encoding.UTF8, "application/json");

        // pass campsiteId so backend attaches to the same campsite you’ve selected
        var url = $"api/units/layout/import?campsiteId={SelectedCampsiteId}";
        var resp = await Http.PostAsync(url, content);

        if (resp.IsSuccessStatusCode)
        {
            StatusKind = "success";
            StatusMessage = "Import lykkedes. Opdaterer…";
            await RefreshForCampsite();
        }
        else
        {
            StatusKind = "danger";
            StatusMessage = "Import fejlede: " + await resp.Content.ReadAsStringAsync();
        }
        StateHasChanged();
    }

    private async Task CreateNewInDb()
    {
        var newOnes = Units.Where(u => !u.FromDb).ToList();
        if (newOnes.Count == 0)
        {
            StatusKind = "warning";
            StatusMessage = "Ingen nye enheder at oprette.";
            StateHasChanged();
            return;
        }

        var body = new
        {
            createMissing = true,
            units = newOnes.Select(u => new
            {
                id = (Guid?)null,
                type = u.ProductType == "Hytte" ? "Cottage" : "Space",
                name = u.Name,
                x = u.X,
                y = u.Y
            })
        };

        try
        {
            var resp = await Http.PostAsJsonAsync("api/units/layout/import?campsiteId=" + SelectedCampsiteId, body);
            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = "Oprettede nye enheder. Opdaterer…";
                await RefreshForCampsite();
            }
            else
            {
                StatusKind = "danger";
                StatusMessage = "Opret fejlede: " + await resp.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl under oprettelse: " + ex.Message;
        }
        StateHasChanged();
    }

    private async Task SaveLayout()
    {
        if (Units.Count == 0)
        {
            StatusKind = "warning";
            StatusMessage = "Ingen enheder at gemme layout for.";
            StateHasChanged();
            return;
        }

        var payload = Units
            .Where(u => u.FromDb)
            .Select(u => new UnitLayoutDto
            {
                Id = Guid.Parse(u.Id),
                Type = u.ProductType == "Hytte" ? "Cottage" : "Space",
                X = u.X,
                Y = u.Y
            }).Where(x => x.Id != Guid.Empty).ToList();

        try
        {
            var url = $"api/units/layout?campsiteId={SelectedCampsiteId}";
            var resp = await Http.PutAsJsonAsync(url, payload);

            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = $"Layout gemt ({payload.Count} enheder).";
                await RefreshForCampsite();
            }
            else
            {
                StatusKind = "danger";
                StatusMessage = "Gem fejlede: " + await resp.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Gem fejlede: " + ex.Message;
        }
        StateHasChanged();
    }

    private async Task LoadFromApi()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId))
        {
            Units.Clear();
            StateHasChanged();
            return;
        }

        try
        {
            var url = $"api/units?campsiteId={SelectedCampsiteId}";
            var data = await Http.GetFromJsonAsync<List<UnitDto>>(url) ?? new();

            Units = data.Select(d => new EditableUnit
            {
                Id = d.Id.ToString(),
                Name = d.Name,
                ProductType = d.Type == "Cottage" ? "Hytte" : "Plads",
                X = d.X,
                Y = d.Y,
                FromDb = true
            }).ToList();

            StatusKind = "info";
            StatusMessage = $"Indlæst {Units.Count} enheder for valgt plads.";
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Kunne ikke hente fra API: " + ex.Message;
        }
        StateHasChanged();
    }

    private async Task LoadOptions()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId)) { Options.Clear(); return; }
        var url = $"api/units/options?campsiteId={SelectedCampsiteId}&unplacedOnly=true";
        Options = await Http.GetFromJsonAsync<List<UnitOption>>(url) ?? new();
        SelectedOptionId = Options.Count > 0 ? Options[0].Id : null;
        StateHasChanged();
    }

    private async Task StartPlaceOnMap()
    {
        if (string.IsNullOrEmpty(SelectedOptionId)) return;
        var opt = Options.FirstOrDefault(o => o.Id == SelectedOptionId);
        if (opt is null) return;

        try
        {
            var newUnit = new EditableUnit
            {
                Id = opt.Id,
                Name = opt.Name,
                ProductType = opt.Type == "Cottage" ? "Hytte" : "Plads",
                X = 400,
                Y = 300,
                FromDb = true
            };

            Units.Add(newUnit);
            _selectedId = newUnit.Id;
            StatusKind = "info";
            StatusMessage = $"Klar til at placere: {newUnit.Name}. Træk markøren på kortet og gem layout.";
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl under placering: " + ex.Message;
        }
        StateHasChanged();
    }
}
