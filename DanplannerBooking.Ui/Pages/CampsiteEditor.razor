@page "/editor"
@using System.Text.Json
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS
@inject HttpClient Http

<h2>🛠️ Kort-editor</h2>
<p class="text-muted">Træk markører for at flytte dem. Pan/zoom på baggrunden.</p>

<div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
    <div class="card" style="min-width:280px; max-width:360px; padding:12px;">
        <h3>Værktøjer</h3>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
            <button class="btn btn-primary" @onclick="AddTent">+ Teltplads</button>
            <button class="btn btn-primary" @onclick="AddCabin">+ Hytte</button>
        </div>

        @if (Selected is not null)
        {
            <hr />
            <h4>Valgt</h4>
            <label>Navn</label>
            <input class="form-control" @bind="Selected.Name" />
            <label class="mt-2">Type</label>
            <select class="form-select" @bind="Selected.ProductType">
                <option value="Plads">Plads</option>
                <option value="Hytte">Hytte</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" class="mt-2">
                <div><label>X</label><input class="form-control" type="number" @bind="Selected.X" /></div>
                <div><label>Y</label><input class="form-control" type="number" @bind="Selected.Y" /></div>
            </div>
            <div class="mt-2" style="display:flex; gap:8px;">
                <button class="btn btn-outline-secondary" @onclick="ApplyManualPosition">↻ Opdater</button>
                <button class="btn btn-outline-danger" @onclick="DeleteSelected">🗑️ Slet</button>
            </div>
        }

        <hr />
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn btn-outline-primary" @onclick="ExportJson">⬇️ Export</button>

            <label class="btn btn-outline-secondary" style="margin:0;">
                ⬆️ Import
                <InputFile OnChange="ImportJson" accept=".json,.txt,application/json" class="ms-2" />
            </label>

            <button class="btn btn-outline-warning" @onclick="CreateNewInDb"
                    disabled="@(!Units.Any(u => !u.FromDb))">
                Opret nye i DB
            </button>

            <button class="btn btn-success" @onclick="SaveLayout"
                    disabled="@(!Units.Any(u => u.FromDb))">
                Gem layout
            </button>
        </div>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="alert mt-2 py-2" style="border-radius:8px; font-size:.95rem; @(StatusKind switch { "success" => "background:#e6ffed;border:1px solid #b7f5c6;color:#055b27;", "danger" => "background:#ffecec;border:1px solid #f5b7b7;color:#7a1111;", "warning" => "background:#fff8e6;border:1px solid #f5e0b7;color:#7a5b05;", _ => "background:#eef4ff;border:1px solid #c8d9ff;color:#0b3d91;" })">
                @StatusMessage
            </div>
        }
    </div>

    <div id="mapContainer" style="flex:1 1 820px; min-width:760px; height:75vh; border:1px solid #ccc; border-radius:10px; overflow:hidden;">
        <svg id="campsiteSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1336 768" style="width:100%; height:100%;">
            <image href="images/campsite.jpg" x="0" y="0" width="1336" height="768" />
            @foreach (var u in Units)
            {
                var isSel = _selectedId == u.Id;
                var border = isSel ? "stroke-width:3; stroke:#fff" : "stroke-width:2; stroke:#fff";
                <g class="unit @(u.ProductType == "Hytte" ? "hut" : "tent")"
                   data-id="@u.Id"
                   transform="translate(@u.X,@u.Y)"
                   @onclick="() => _selectedId = u.Id">
                    @if (u.ProductType == "Hytte")
                    {
                        <rect x="-16" y="-12" rx="5" ry="5" width="32" height="24" style="fill:rgba(0,0,255,.55); @border"></rect>
                        <path d="M-18 -12 L0 -26 L18 -12" style="fill:#0039b3; opacity:.85"></path>
                    }
                    else
                    {
                        <circle r="12" style="fill:rgba(0,200,0,.6); @border"></circle>
                    }
                    <text y="-20" text-anchor="middle" fill="white" font-size="12">
                        @u.Name @if(!u.FromDb){
                        <tspan fill="#ffd54f"> (ny)</tspan>
                    }
                </text>
            </g>
                        }
        </svg>
    </div>
</div>

@code {
    private string? StatusMessage;
    private string StatusKind = "info"; // "success" | "danger" | "warning" | "info"

    public record EditableUnit
    {
        public string Id { get; init; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = "Plads";
        public string ProductType { get; set; } = "Plads"; // "Plads" | "Hytte"
        public int X { get; set; }
        public int Y { get; set; }
        public bool FromDb { get; set; } = false; // ← NYT: om enheden findes i DB
    }

    private List<EditableUnit> Units = new(); // vi loader fra API
    private string? _selectedId;
    private EditableUnit? Selected => Units.FirstOrDefault(z => z.Id == _selectedId);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
            await JS.InvokeVoidAsync("CampsiteMap.enableDrag", "#campsiteSvg", "g.unit", DotNetObjectReference.Create(this));
            await LoadFromApi();
        }
    }

    [JSInvokable]
    public Task OnMarkerMoved(string id, int x, int y)
    {
        var u = Units.FirstOrDefault(z => z.Id == id);
        if (u is not null) { u.X = x; u.Y = y; StateHasChanged(); }
        return Task.CompletedTask;
    }

    private void AddTent()
    {
        var idx = Units.Count(u => u.ProductType == "Plads") + 101;
        Units.Add(new EditableUnit { Name = $"P-{idx}", ProductType = "Plads", X = 200, Y = 200, FromDb = false });
    }

    private void AddCabin()
    {
        var idx = Units.Count(u => u.ProductType == "Hytte") + 201;
        Units.Add(new EditableUnit { Name = $"H-{idx}", ProductType = "Hytte", X = 230, Y = 230, FromDb = false });
    }

    private void DeleteSelected()
    {
        if (_selectedId is null) return;
        Units = Units.Where(u => u.Id != _selectedId).ToList();
        _selectedId = null;
    }

    private void ApplyManualPosition() => StateHasChanged();

    private async Task ExportJson()
    {
        var json = JsonSerializer.Serialize(Units, new JsonSerializerOptions { WriteIndented = true });
        await JS.InvokeVoidAsync("CampsiteMap.downloadText", "campsite-layout.json", json);
    }

    // IMPORT: fil -> importer -> reload fra API
    private async Task ImportJson(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        using var stream = file.OpenReadStream(maxAllowedSize: 1_048_576);
        using var reader = new StreamReader(stream);
        var text = await reader.ReadToEndAsync();

        var payload = text.TrimStart().StartsWith("{")
            ? text
            : $"{{\"createMissing\":true,\"units\":{text}}}";

        var content = new StringContent(payload, System.Text.Encoding.UTF8, "application/json");
        var resp = await Http.PostAsync("api/units/layout/import", content);

        if (resp.IsSuccessStatusCode)
        {
            StatusKind = "success";
            StatusMessage = "Layout importeret. Henter fra API…";
            await LoadFromApi();
        }
        else
        {
            StatusKind = "danger";
            StatusMessage = "Import fejlede: " + await resp.Content.ReadAsStringAsync();
        }
        StateHasChanged();
    }

    // HENT: læs alle enheder fra API
    private async Task LoadFromApi()
    {
        try
        {
            var data = await Http.GetFromJsonAsync<List<UnitDto>>("api/units") ?? new();

            Units = data.Select(d => new EditableUnit
            {
                Id = d.Id.ToString(),
                Name = d.Name,
                ProductType = d.Type == "Cottage" ? "Hytte" : "Plads",
                X = d.X,
                Y = d.Y,
                FromDb = true // ← marker disse som DB-eksisterende
            }).ToList();

            StatusKind = "info";
            StatusMessage = $"Indlæst {Units.Count} enheder fra API.";
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Kunne ikke hente fra API: " + ex.Message;
        }
        StateHasChanged();
    }

    // OPRET NYE: send nye (FromDb=false) til importer
    private async Task CreateNewInDb()
    {
        var newOnes = Units.Where(u => !u.FromDb).ToList();
        if (newOnes.Count == 0)
        {
            StatusKind = "warning";
            StatusMessage = "Ingen nye enheder at oprette.";
            StateHasChanged();
            return;
        }

        var body = new
        {
            createMissing = true,
            units = newOnes.Select(u => new
            {
                id = (Guid?)null,
                name = u.Name,
                type = u.ProductType == "Hytte" ? "Cottage" : "Space",
                x = u.X,
                y = u.Y
            }).ToList()
        };

        try
        {
            var resp = await Http.PostAsJsonAsync("api/units/layout/import", body);
            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = $"Oprettede {newOnes.Count} nye enheder i DB. Henter fra API…";
                await LoadFromApi();
            }
            else
            {
                StatusKind = "danger";
                StatusMessage = "Opret fejlede: " + await resp.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Opret fejlede: " + ex.Message;
        }
        StateHasChanged();
    }

    // GEM: send X/Y for eksisterende DB-enheder, reload bagefter
    private async Task SaveLayout()
    {
        try
        {
            var toSave = Units.Where(u => u.FromDb).ToList();
            if (toSave.Count == 0)
            {
                StatusKind = "warning";
                StatusMessage = "Ingen eksisterende DB-enheder at gemme. Brug 'Opret nye i DB' først.";
                StateHasChanged();
                return;
            }

            var payload = toSave.Select(u => new
            {
                id = Guid.TryParse(u.Id, out var gid) ? gid : Guid.Empty,
                type = u.ProductType == "Hytte" ? "Cottage" : "Space",
                x = u.X,
                y = u.Y
            }).Where(x => x.id != Guid.Empty).ToList();

            var resp = await Http.PutAsJsonAsync("api/units/layout", payload);
            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = $"Layout gemt ({payload.Count} enheder). Henter fra API…";
                await LoadFromApi();
            }
            else
            {
                StatusKind = "danger";
                StatusMessage = "Gem fejlede: " + await resp.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Gem fejlede: " + ex.Message;
        }
        StateHasChanged();
    }
}
