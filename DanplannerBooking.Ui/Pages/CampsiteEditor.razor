@page "/editor"
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Navigation

<h2>🗺️ Kort-editor</h2>
<p class="text-muted">
    Vælg campingplads, opret enheder, træk markører rundt på kortet og gem layoutet.
</p>

<div class="mb-3" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
    <!-- Campsite vælger -->
    <div style="min-width:320px; max-width:420px">
        <label class="form-label">Vælg campingplads</label>
        <select class="form-select"
                @bind="SelectedCampsiteIdString"
                @bind:after="OnCampsiteChanged">
            <option value="">-- vælg --</option>
            @foreach (var c in Campsites)
            {
                <option value="@c.Id.ToString()">@c.Name</option>
            }
        </select>

        @if (SelectedCampsite is not null)
        {
            <div class="card mt-2" style="padding:8px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="width:72px; height:48px; overflow:hidden; border-radius:6px; border:1px solid #ddd;">
                        @if (SelectedCampsite.Image is not null)
                        {
                            <img src="@($"data:image/png;base64,{Convert.ToBase64String(SelectedCampsite.Image)}")"
                                 style="width:100%; height:100%; object-fit:cover;" />
                        }
                    </div>
                    <div>
                        <strong>@SelectedCampsite.Name</strong>
                        <div class="text-muted" style="font-size:.8rem;">
                            @Units.Count enheder på kortet
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="alert alert-info mt-4" style="flex:1; min-width:280px;">
        Træk markører direkte på kortet for at flytte dem.
        Brug "Placer DB-enhed" for at give DB-enheder en position.
    </div>
</div>

<div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
    <!-- Venstre panel -->
    <div style="width:360px; max-width:100%;">
        <div class="card" style="padding:12px;">
            <h5>Enheder på kortet</h5>
            <p class="text-muted" style="font-size:.85rem;">
                Træk markørerne rundt på kortet. Her kan du også fjerne en enhed fra layoutet.
            </p>

            <div style="max-height:240px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:8px;">
                @if (!Units.Any())
                {
                    <p class="text-muted mb-0">Ingen enheder på kortet endnu.</p>
                }
                else
                {
                    @foreach (var u in Units)
                    {
                        var isSel = Selected?.Id == u.Id;

                        <div class="d-flex justify-content-between align-items-center mb-1 @(isSel ? "bg-light" : "")"
                             style="border-radius:4px; padding:4px 6px;">
                            <div>
                                <strong>@u.Name</strong>
                                <span class="badge bg-secondary ms-1">@u.Type</span>
                                @if (!u.FromDb)
                                {
                                    <span class="badge bg-warning text-dark ms-1">ny</span>
                                }
                                <div class="text-muted" style="font-size:.8rem;">
                                    X=@u.X, Y=@u.Y
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => DeleteUnit(u.Id))">
                                ✕
                            </button>
                        </div>
                    }
                }
            </div>

            <hr />

            <h5>Opret DB-enhed</h5>
            <p class="text-muted" style="font-size:.85rem;">
                Opret nye pladser og hytter på deres respektive sider.
                Herefter kan de placeres på kortet nedenfor.
            </p>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <button class="btn btn-primary" @onclick="GoToCreateSpace" disabled="@DisabledNoCampsite">+ Plads</button>
                <button class="btn btn-primary" @onclick="GoToCreateCottage" disabled="@DisabledNoCampsite">+ Hytte</button>
            </div>

            @if (Selected is not null)
            {
                <hr />
                <h4>Valgt enhed</h4>
                <div class="row mt-2">
                    <div class="col">
                        <label>X</label>
                        <input class="form-control" type="number" @bind="Selected.X" />
                    </div>
                    <div class="col">
                        <label>Y</label>
                        <input class="form-control" type="number" @bind="Selected.Y" />
                    </div>
                </div>

                <button class="btn btn-outline-secondary mt-2" @onclick="ApplyManualPosition">
                    ↻ Opdater
                </button>
            }
        </div>

        <div class="card mt-3" style="padding:12px;">
            <h5>Placer DB-enhed</h5>
            <p class="text-muted" style="font-size:.85rem;">
                Vælg en DB-enhed uden position, og klik "Placer markør på kort".
            </p>

            <select class="form-select" @bind="SelectedOptionId" disabled="@DisabledNoCampsite">
                <option value="">-- vælg enhed uden position --</option>
                @foreach (var o in Options)
                {
                    <option value="@o.Id.ToString()">@o.Name (@o.Type)</option>
                }
            </select>

            <button class="btn btn-outline-primary mt-2"
                    @onclick="StartPlaceOnMap"
                    disabled="@DisabledNoCampsite || Options.Count == 0">
                Placer markør på kort
            </button>

            <div class="mt-3">
                <button class="btn btn-success" @onclick="SaveLayout">
                    💾 Gem layout i DB
                </button>
            </div>

            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="alert alert-@StatusKind mt-3">@StatusMessage</div>
            }
        </div>
    </div>

    <!-- Kortet -->
    <div style="flex:1; min-width:320px;">
        <div id="mapContainer"
             style="border-radius:12px; overflow:hidden; border:1px solid #ccc; position:relative; width:800px; max-width:100%;">
            <svg id="campsiteSvg"
                 xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 800 600"
                 style="width:100%; height:auto; background:#f8f9fa;">

                @if (SelectedCampsite?.Image is not null)
                {
                    <image href="@($"data:image/png;base64,{Convert.ToBase64String(SelectedCampsite.Image)}")"
                           x="0" y="0" width="800" height="600" />
                }

                @foreach (var u in Units)
                {
                    var isSel = Selected?.Id == u.Id;
                    var stroke = isSel ? "stroke:white;stroke-width:3" : "stroke:white;stroke-width:2";

                    <g class="unit"
                       data-id="@u.Id"
                       transform="translate(@u.X,@u.Y)"
                       @onclick="() => OnUnitClicked(u)">
                        @if (u.Type == "Cottage")
                        {
                            <rect x="-16" y="-12" width="32" height="24"
                                  style="fill:#28a745; @stroke" />
                        }
                        else
                        {
                            <circle r="12" style="fill:#007bff; @stroke"></circle>
                        }
                        <text y="-20" text-anchor="middle" fill="white" font-size="12">
                            @u.Name
                        </text>
                    </g>
                }
            </svg>
        </div>
    </div>
</div>

@code {
    // ---------- Små interne DTO'er til API ----------
    private sealed class ApiCampsiteDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public byte[]? Image { get; set; }
    }

    private sealed class ApiUnitDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";  // "Space" | "Cottage"
        public int X { get; set; }
        public int Y { get; set; }
        public Guid CampsiteId { get; set; }
    }

    private sealed class ApiUnitOptionDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public bool HasPosition { get; set; }
        public Guid CampsiteId { get; set; }
    }

    // ---------- UI modeller ----------
    private sealed class UiCampsite
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public byte[]? Image { get; set; }
    }

    private sealed class EditableUnit
    {
        public Guid Id { get; set; }
        public Guid CampsiteId { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";    // "Space" | "Cottage"
        public int X { get; set; }
        public int Y { get; set; }
        public bool FromDb { get; set; }
    }

    private sealed class UnitOption
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public Guid CampsiteId { get; set; }
    }

    // ---------- State ----------
    private List<UiCampsite> Campsites { get; set; } = new();
    private string? SelectedCampsiteIdString { get; set; }
    private Guid? SelectedCampsiteId =>
        Guid.TryParse(SelectedCampsiteIdString, out var g) ? g : (Guid?)null;

    private UiCampsite? SelectedCampsite =>
        SelectedCampsiteId is null
            ? null
            : Campsites.FirstOrDefault(c => c.Id == SelectedCampsiteId.Value);

    private List<EditableUnit> Units { get; set; } = new();
    private EditableUnit? Selected { get; set; }

    private List<UnitOption> Options { get; set; } = new();
    private string? SelectedOptionId { get; set; }

    private string StatusMessage { get; set; } = "";
    private string StatusKind { get; set; } = "info";

    private bool DisabledNoCampsite => SelectedCampsiteId is null;

    // ---------- Lifecycle ----------
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Global JS fra wwwroot/js/map.js
            await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
            await JS.InvokeVoidAsync("CampsiteMap.enableDrag", "#campsiteSvg", "g.unit",
                DotNetObjectReference.Create(this));

            await LoadCampsites();
        }
    }

    private async Task LoadCampsites()
    {
        try
        {
            var list = await Http.GetFromJsonAsync<List<ApiCampsiteDto>>("api/campsite") ?? new();
            Campsites = list.Select(c => new UiCampsite
            {
                Id = c.Id,
                Name = c.Name,
                Image = c.Image
            }).ToList();
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved indlæsning af campingpladser: " + ex.Message;
        }

        StateHasChanged();
    }

    private async Task OnCampsiteChanged()
    {
        await ReloadForSelectedCampsite();
    }

    private async Task ReloadForSelectedCampsite()
    {
        Units.Clear();
        Options.Clear();
        Selected = null;

        if (SelectedCampsiteId is null)
        {
            StateHasChanged();
            return;
        }

        await LoadUnits();
        await LoadOptions();

        StateHasChanged();
    }

    private async Task LoadUnits()
    {
        if (SelectedCampsiteId is null) return;

        var url = $"api/units?campsiteId={SelectedCampsiteId}";
        var data = await Http.GetFromJsonAsync<List<ApiUnitDto>>(url) ?? new();

        Units = data.Select(u => new EditableUnit
        {
            Id = u.Id,
            CampsiteId = u.CampsiteId,
            Name = u.Name,
            Type = u.Type,
            X = u.X,
            Y = u.Y,
            FromDb = true
        }).ToList();
    }

    private async Task LoadOptions()
    {
        if (SelectedCampsiteId is null) return;

        var url = $"api/units/options?campsiteId={SelectedCampsiteId}";
        var data = await Http.GetFromJsonAsync<List<ApiUnitOptionDto>>(url) ?? new();

        Options = data
            .Where(o => !o.HasPosition)
            .Select(o => new UnitOption
            {
                Id = o.Id,
                Name = o.Name,
                Type = o.Type,
                CampsiteId = o.CampsiteId
            })
            .ToList();
    }

    // ---------- UI-hændelser ----------
    private void GoToCreateSpace() => Navigation.NavigateTo("/create-space");
    private void GoToCreateCottage() => Navigation.NavigateTo("/create-cottage");

    private async Task OnUnitClicked(EditableUnit u)
    {
        Selected = u;
        // Hvis map.js har en highlight-funktion, kan den kaldes her
        try
        {
            await JS.InvokeVoidAsync("CampsiteMap.highlight", u.Id.ToString());
        }
        catch
        {
            // ignore hvis funktionen ikke findes
        }
        StateHasChanged();
    }

    private void ApplyManualPosition()
    {
        // vi lader StateHasChanged trigge et rerender, JS-siden står for placering
        StateHasChanged();
    }

    private void DeleteUnit(Guid id)
    {
        var u = Units.FirstOrDefault(x => x.Id == id);
        if (u is not null)
        {
            Units.Remove(u);
            if (u.FromDb)
            {
                // DB-enheder der fjernes fra kortet kunne evt. tilføjes til Options igen.
                Options.Add(new UnitOption
                {
                    Id = u.Id,
                    Name = u.Name,
                    Type = u.Type,
                    CampsiteId = u.CampsiteId
                });
            }
        }

        if (Selected?.Id == id)
            Selected = null;

        StateHasChanged();
    }

    private async Task StartPlaceOnMap()
    {
        if (SelectedCampsiteId is null || string.IsNullOrEmpty(SelectedOptionId))
            return;

        if (!Guid.TryParse(SelectedOptionId, out var optId))
            return;

        var opt = Options.FirstOrDefault(o => o.Id == optId);
        if (opt is null) return;

        try
        {
            // map.js forventer typisk (id, type)
            await JS.InvokeVoidAsync(
                "CampsiteMap.startPlaceNewMarker",
                opt.Id.ToString(),
                opt.Type);

            StatusKind = "info";
            StatusMessage = $"Placer markør for: {opt.Name}";
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved start af placering: " + ex.Message;
        }

        StateHasChanged();
    }

    private async Task SaveLayout()
    {
        if (SelectedCampsiteId is null)
        {
            StatusKind = "warning";
            StatusMessage = "Vælg en campingplads først.";
            return;
        }

        try
        {
            var payload = Units.Select(u => new ApiUnitDto
            {
                Id = u.Id,
                Name = u.Name,
                Type = u.Type,
                X = u.X,
                Y = u.Y,
                CampsiteId = u.CampsiteId
            }).ToList();

            var resp = await Http.PutAsJsonAsync(
                $"api/units/layout?campsiteId={SelectedCampsiteId}",
                payload);

            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = "Layout gemt.";
            }
            else
            {
                StatusKind = "danger";
                StatusMessage = $"Fejl ved gem: {resp.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved gem: " + ex.Message;
        }

        StateHasChanged();
    }

    // ---------- JS → .NET callbacks ----------
    [JSInvokable]
    public Task OnMarkerMoved(Guid id, int x, int y)
    {
        try
        {
            var unit = Units.FirstOrDefault(u => u.Id == id);
            if (unit is not null)
            {
                unit.X = x;
                unit.Y = y;

                if (Selected?.Id == id)
                {
                    Selected.X = x;
                    Selected.Y = y;
                }
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved flytning af markør: " + ex.Message;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnMarkerClicked(Guid id)
    {
        try
        {
            var unit = Units.FirstOrDefault(u => u.Id == id);
            if (unit is not null)
            {
                Selected = unit;
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved klik på markør: " + ex.Message;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNewMarkerPlaced(Guid id, int x, int y)
    {
        try
        {
            var opt = Options.FirstOrDefault(o => o.Id == id);
            if (opt is null)
                return Task.CompletedTask;

            var unit = new EditableUnit
            {
                Id = opt.Id,
                CampsiteId = opt.CampsiteId,
                Name = opt.Name,
                Type = opt.Type,
                X = x,
                Y = y,
                FromDb = true
            };

            Units.Add(unit);
            Options.Remove(opt);
            Selected = unit;
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved placering af markør: " + ex.Message;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }
}
