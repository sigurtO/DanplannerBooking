@page "/editor"
@using System.Text.Json
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Navigation

<h2>🗺️ Kort-editor</h2>
<p class="text-muted">Vælg campingplads, importer/opret enheder, træk markører, og gem layout.</p>

<div class="mb-3" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
    <div style="min-width:320px; max-width:420px">
        <label class="form-label">Vælg campingplads</label>
        <select class="form-select"
                @bind="SelectedCampsiteId"
                @bind:after="OnCampsiteChanged">
            <option value="">-- vælg --</option>
            @if (Campsites.Any())
            {
                @foreach (var c in Campsites)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            }
        </select>

        @if (SelectedCampsite is not null)
        {
            <div class="mt-2 card" style="padding:8px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="width:72px; height:48px; overflow:hidden; border-radius:6px; border:1px solid #ddd;">
                        <img src="@BgImageBase64" alt="Campsite preview" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                    <div>
                        <div><strong>@SelectedCampsite.Name</strong></div>
                        <div class="text-muted" style="font-size:.85rem;">Billedsti: <code>@BgImageBase64</code></div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="alert alert-info mt-4" style="flex:1;min-width:280px;">
        Træk markører for at flytte dem. Brug “Placer markør på kort” for at give DB-enheder en placering.
    </div>
</div>

<div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
    <div class="card" style="min-width:280px; max-width:360px; padding:12px;">
        <h3>Værktøjer</h3>
        <p class="text-muted" style="font-size:.9rem;">
            Opret nye enheder på /create-space og /create-cottage, og placer dem derefter her på kortet.
        </p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
            <button class="btn btn-primary" @onclick="GoToCreateSpace" disabled="@DisabledNoCampsite">+ Ny plads</button>
            <button class="btn btn-primary" @onclick="GoToCreateCottage" disabled="@DisabledNoCampsite">+ Ny hytte</button>
        </div>

        @if (Selected is not null)
        {
            <hr />
            <h4>Valgt</h4>
            <div class="mb-2">
                <label class="form-label">Navn</label>
                <input class="form-control" @bind="Selected.Name" />
            </div>
            <div class="mb-2">
                <label class="form-label">Type</label>
                <select class="form-select" @bind="Selected.ProductType">
                    <option value="Plads">Plads</option>
                    <option value="Hytte">Hytte</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" class="mt-2">
                <div><label>X</label><input class="form-control" type="number" @bind="Selected.X" /></div>
                <div><label>Y</label><input class="form-control" type="number" @bind="Selected.Y" /></div>
            </div>
            <div class="mt-2" style="display:flex; gap:8px;">
                <button class="btn btn-outline-secondary" @onclick="ApplyManualPosition">↻ Opdater</button>
                <button class="btn btn-outline-danger" @onclick="DeleteSelected">🗑️ Slet</button>
            </div>

            @if (SelectedBookings is not null && SelectedBookings.Count > 0)
            {
                <div class="mt-3">
                    <h5>Bookinger</h5>
                    <ul class="list-unstyled">
                        @foreach (var b in SelectedBookings)
                        {
                            <li class="mb-1">
                                <strong>@b.DateStart.ToString("dd-MM-yyyy") - @b.DateEnd.ToString("dd-MM-yyyy")</strong><br />
                                @b.UserName (@b.NumberOfPeople personer) – @b.TotalPrice.ToString("C")
                            </li>
                        }
                    </ul>
                </div>
            }
            else
            {
                <p class="mt-2 text-muted">Ingen bookinger for denne enhed.</p>
            }
        }
        else
        {
            <p class="text-muted mt-2">Klik på en markør på kortet for at vælge.</p>
        }

        <hr />
        <h5>Placer DB-enhed</h5>
        <p class="text-muted" style="font-size:.85rem;">
            Vælg en DB-enhed uden placering, og klik “Placer markør på kort”.
        </p>
        <div class="mb-2">
            <select class="form-select" @bind="SelectedOptionId" disabled="@DisabledNoCampsite">
                @if (Options.Count == 0)
                {
                    <option value="">(ingen enheder uden placering)</option>
                }
                else
                {
                    @foreach (var o in Options)
                    {
                        <option value="@o.Id">@o.Name (@o.Type)</option>
                    }
                }
            </select>
            <button class="btn btn-outline-primary mt-2" @onclick="StartPlaceOnMap" disabled="@DisabledNoCampsite || Options.Count == 0">
                Placer markør på kort
            </button>
        </div>

        <hr />
        <div class="mb-2">
            <button class="btn btn-outline-secondary me-2" @onclick="ExportJson" disabled="@DisabledNoCampsite || !Units.Any()">
                ⬇️ Export layout (JSON)
            </button>
            <label class="btn btn-outline-secondary mb-0">
                ⬆️ Import layout
                <InputFile OnChange="ImportJson" accept=".json,application/json" class="d-none" />
            </label>
        </div>

        <div class="mt-2">
            <button class="btn btn-success" @onclick="SaveLayout">
                💾 Gem layout i DB
            </button>
        </div>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="alert alert-@StatusKind mt-3">@StatusMessage</div>
        }
    </div>

    <div style="flex:1; min-width:320px;">
        <div id="mapContainer"
             style="border-radius:12px; overflow:hidden; border:1px solid #ccc; position:relative; width:800px; max-width:100%; height:600px;">
            <svg id="campsiteSvg" viewBox="0 0 800 600" style="width:100%; height:100%;">
                <defs>
                    <pattern id="editorBg" patternUnits="userSpaceOnUse" width="800" height="600">
                        <image href="@BgImageBase64" x="0" y="0" width="800" height="600" preserveAspectRatio="xMidYMid slice" />
                    </pattern>
                </defs>
                <rect x="0" y="0" width="800" height="600" fill="url(#editorBg)" />

                @foreach (var u in Units)
                {
                    var isSel = _selectedId == u.Id;
                    var border = isSel ? "stroke-width:3; stroke:#fff" : "stroke-width:2; stroke:#fff";
                    <g class="unit @(u.ProductType == "Hytte" ? "hut" : "tent")"
                       data-id="@u.Id"
                       transform="translate(@u.X,@u.Y)"
                       @onclick="() => OnUnitClicked(u)">
                        @if (u.ProductType == "Hytte")
                        {
                            <rect x="-16" y="-12" rx="5" ry="5" width="32" height="24" style="fill:rgba(0,0,255,.55); @border"></rect>
                            <path d="M-18 -12 L0 -26 L18 -12" style="fill:#0039b3; opacity:.85"></path>
                        }
                        else
                        {
                            <circle r="12" style="fill:rgba(0,200,0,.6); @border"></circle>
                        }
                        <text y="-20" text-anchor="middle" fill="white" font-size="12">
                            @u.Name @if(!u.FromDb){
                            <tspan fill="#ffd54f"> (ny)</tspan>
                        }
                        </text>
                    </g>
                }
            </svg>
        </div>
    </div>
</div>

@code {
    // ---------- Campsites ----------
    private sealed class UiCampsite
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public byte[]? Image { get; set; }
    }
    private List<UiCampsite> Campsites = new();
    private string? SelectedCampsiteId;
    private UiCampsite? SelectedCampsite => Campsites.FirstOrDefault(c => c.Id == SelectedCampsiteId);
    private string BgImageBase64 =>
        (SelectedCampsite?.Image?.Length > 0)
        ? $"data:image/png;base64,{Convert.ToBase64String(SelectedCampsite.Image)}"
        : null;

    private bool DisabledNoCampsite => string.IsNullOrEmpty(SelectedCampsiteId);
    private bool DisabledNoNew => DisabledNoCampsite || !Units.Any(u => !u.FromDb);
    private bool DisabledNoDb => DisabledNoCampsite || !Units.Any(u => u.FromDb);

    // ---------- Units ----------

    private sealed class EditableUnit
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = "";
        public string ProductType { get; set; } = "Plads"; // "Hytte" eller "Plads"
        public int X { get; set; } = 200;
        public int Y { get; set; } = 200;
        public bool FromDb { get; set; }  // true hvis enheden allerede findes i DB
    }

    private List<EditableUnit> Units = new();
    private string? _selectedId;
    private EditableUnit? Selected => Units.FirstOrDefault(u => u.Id == _selectedId);

    // ---------- Options fra DB ----------

    private sealed class UnitOption
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public bool HasPosition { get; set; }
        public string CampsiteId { get; set; } = "";
    }
    private List<UnitOption> Options = new();
    private string? SelectedOptionId;

    // ---------- Booking-summary til editor-visning ----------
    private sealed class BookingSummary
    {
        public Guid Id { get; set; }
        public DateTime DateStart { get; set; }
        public DateTime DateEnd { get; set; }
        public string UserName { get; set; } = "";
        public int NumberOfPeople { get; set; }
        public decimal TotalPrice { get; set; }
    }
    private List<BookingSummary> SelectedBookings { get; set; } = new();

    // ---------- Status ----------
    private string? StatusKind;   // "success", "danger", "info", osv.
    private string? StatusMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
            await JS.InvokeVoidAsync("CampsiteMap.enableDrag", "#campsiteSvg", "g.unit", DotNetObjectReference.Create(this));
            await LoadCampsites();
        }
    }

    private async Task LoadCampsites()
    {
        try
        {
            var data = await Http.GetFromJsonAsync<List<CampsiteResponseDto>>("api/campsite") ?? new();
            Campsites = data.Select(c => new UiCampsite
            {
                Id = c.Id.ToString(),
                Name = c.Name,
                Image = c.Image
            }).ToList();
        }
        catch
        {
            Campsites = new();
        }

        if (string.IsNullOrEmpty(SelectedCampsiteId) && Campsites.Count > 0)
            SelectedCampsiteId = Campsites[0].Id;

        await RefreshForCampsite();
        StateHasChanged();
    }


    private async Task OnCampsiteChanged() => await RefreshForCampsite();

    private async Task RefreshForCampsite()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId))
        {
            Units.Clear(); Options.Clear(); StateHasChanged(); return;
        }
        await LoadFromApi();
        await LoadOptions();
    }

    private async Task OnUnitClicked(EditableUnit u)
    {
        _selectedId = u.Id;
        SelectedBookings = new List<BookingSummary>();

        try
        {
            // find type: "Space" eller "Cottage"
            var type = u.ProductType == "Hytte" ? "Cottage" : "Space";
            var url = $"api/booking/by-unit/{u.Id}?type={type}";
            var data = await Http.GetFromJsonAsync<List<BookingSummary>>(url) ?? new();
            SelectedBookings = data;
        }
        catch
        {
            SelectedBookings = new();
        }

        StateHasChanged();
    }

    [JSInvokable]
    public Task OnMarkerMoved(string id, int x, int y)
    {
        var u = Units.FirstOrDefault(z => z.Id == id);
        if (u is not null) { u.X = x; u.Y = y; StateHasChanged(); }
        return Task.CompletedTask;
    }

    private void DeleteSelected()
    {
        if (_selectedId is null) return;
        Units = Units.Where(u => u.Id != _selectedId).ToList();
        _selectedId = null;
        SelectedBookings.Clear();
    }

    private void ApplyManualPosition() => StateHasChanged();

    private async Task ExportJson()
    {
        var json = JsonSerializer.Serialize(Units, new JsonSerializerOptions { WriteIndented = true });
        await JS.InvokeVoidAsync("CampsiteMap.downloadText", "campsite-layout.json", json);
    }

    private async Task ImportJson(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        using var stream = file.OpenReadStream();
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var json = System.Text.Encoding.UTF8.GetString(ms.ToArray());

        try
        {
            var imported = JsonSerializer.Deserialize<List<EditableUnit>>(json) ?? new List<EditableUnit>();
            if (imported.Count == 0)
            {
                StatusKind = "warning";
                StatusMessage = "Ingen enheder fundet i filen.";
            }
            else
            {
                Units = imported;
                StatusKind = "success";
                StatusMessage = "Layout importeret. Husk at gemme til DB.";
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved import: " + ex.Message;
        }

        StateHasChanged();
    }

    private async Task SaveLayout()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId) || Units.Count == 0)
        {
            StatusKind = "warning";
            StatusMessage = "Vælg en campingplads og sørg for at der er enheder på kortet.";
            StateHasChanged();
            return;
        }

        var campsiteGuid = Guid.Parse(SelectedCampsiteId);

        // GEM ALLE UNITS – også nye
        var payload = Units
            .Select(u => new UnitLayoutDto
            {
                Id = Guid.Parse(u.Id),
                Type = u.ProductType == "Hytte" ? "Cottage" : "Space",
                X = u.X,
                Y = u.Y
            })
            .ToList();

        try
        {
            var url = $"api/units/layout?campsiteId={campsiteGuid}";
            var resp = await Http.PutAsJsonAsync(url, payload);

            if (resp.IsSuccessStatusCode)
            {
                StatusKind = "success";
                StatusMessage = $"Layout gemt ({payload.Count} enheder).";
            }
            else
            {
                var body = await resp.Content.ReadAsStringAsync();
                StatusKind = "danger";
                StatusMessage = $"Fejl ved gemning: {resp.StatusCode} - {body}";
            }
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved gemning: " + ex.Message;
        }

        StateHasChanged();
    }





    private async Task LoadFromApi()
    {
        Units.Clear();
        if (string.IsNullOrEmpty(SelectedCampsiteId)) return;

        var url = $"api/units?campsiteId={SelectedCampsiteId}";
        try
        {
            var data = await Http.GetFromJsonAsync<List<UnitDto>>(url) ?? new();
            foreach (var u in data)
            {
                Units.Add(new EditableUnit
                {
                    Id = u.Id.ToString(),
                    Name = u.Name,
                    ProductType = u.Type == "Cottage" ? "Hytte" : "Plads",
                    X = u.X,
                    Y = u.Y,
                    FromDb = true
                });
            }
        }
        catch
        {
            StatusKind = "danger";
            StatusMessage = "Fejl ved indlæsning af enheder fra API.";
        }

        StateHasChanged();
    }

    private async Task LoadOptions()
    {
        if (string.IsNullOrEmpty(SelectedCampsiteId)) { Options.Clear(); return; }
        var url = $"api/units/options?campsiteId={SelectedCampsiteId}&unplacedOnly=true";
        Options = await Http.GetFromJsonAsync<List<UnitOption>>(url) ?? new();
        SelectedOptionId = Options.Count > 0 ? Options[0].Id : null;
        StateHasChanged();
    }

    private async Task StartPlaceOnMap()
    {
        if (string.IsNullOrEmpty(SelectedOptionId)) return;
        var opt = Options.FirstOrDefault(o => o.Id == SelectedOptionId);
        if (opt is null) return;

        try
        {
            var newUnit = new EditableUnit
            {
                Id = opt.Id,
                Name = opt.Name,
                ProductType = opt.Type == "Cottage" ? "Hytte" : "Plads",
                X = 400,
                Y = 300,
                FromDb = true
            };

            Units.Add(newUnit);
            _selectedId = newUnit.Id;
            StatusKind = "info";
            StatusMessage = $"Klar til at placere: {newUnit.Name}. Træk markøren på kortet og gem layout.";
        }
        catch (Exception ex)
        {
            StatusKind = "danger";
            StatusMessage = "Fejl under placering: " + ex.Message;
        }
        StateHasChanged();
    }

    private void GoToCreateSpace() => Navigation.NavigateTo("/create-space");
    private void GoToCreateCottage() => Navigation.NavigateTo("/create-cottage");
}
