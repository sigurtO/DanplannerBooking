<div class="mb-3">
    <label for="@InputId" class="form-label">@Label</label>
    <div class="custom-file-input">
        <InputFile id="@InputId"
                   accept=".jpg,.jpeg,.png"
                   OnChange="HandleImageFile" />
        <span class="custom-file-label">Choose File</span>
    </div>

    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
            <strong>Error!</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="ClearError" aria-label="Close"></button>
        </div>
    }

    @if (ImagePreview != null)
    {
        <div style="margin: 1rem; border: solid black 2px; width: 254px; height: 254px;">
            <img src="@ImagePreview" alt="Image Preview" style="width: 250px; height: 250px;" />
        </div>
    }
</div>

@code {
    [Parameter] public string Label { get; set; } = "Upload Image";
    [Parameter] public string InputId { get; set; } = "imageUpload";
    [Parameter] public EventCallback<byte[]> OnImageSelected { get; set; }

    private string? ImagePreview;
    private string? errorMessage;

    private async Task HandleImageFile(InputFileChangeEventArgs e)
    {
        // Clear previous error
        errorMessage = null;

        if (e.File != null)
        {
            const long maxFileSize = 150000; // ~150KB

            if (e.File.Size > maxFileSize)
            {
                errorMessage = $"Image is too large! Maximum size is {maxFileSize / 1000}KB. Your image is {e.File.Size / 1000}KB.";
                ImagePreview = null; // Clear any previous preview
                return;
            }

            try
            {
                using var stream = new MemoryStream();
                await e.File.OpenReadStream(maxAllowedSize: maxFileSize).CopyToAsync(stream);
                var imageBytes = stream.ToArray();

                // Image preview
                ImagePreview = $"data:{e.File.ContentType};base64,{Convert.ToBase64String(imageBytes)}";

                // Event callback to parent
                await OnImageSelected.InvokeAsync(imageBytes);
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to upload image: {ex.Message}";
                ImagePreview = null;
            }
        }
    }

    private void ClearError()
    {
        errorMessage = null;
    }
}
