@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager NavigationManager
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos
@using DanplannerBooking.Application.Dtos.Campsite
@using DanplannerBooking.Application.Dtos.Cottage
@using DanplannerBooking.Application.Dtos.Space

<h2>🏕️ Pladskort</h2>
<p class="text-muted">Vælg campingplads og se kortet med hytter og teltpladser.</p>

<div class="mb-3" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <label class="form-label mb-0">Vælg campingplads:</label>
    <select class="form-select" style="max-width:300px;" @bind="SelectedCampsiteId" @bind:after="OnCampsiteChanged">
        @if (Campsites.Count == 0)
        {
            <option value="">(indlæser...)</option>
        }
        else
        {
            <option value="">— vælg —</option>
            @foreach (var c in Campsites.DistinctBy(c => c.Id))
            {
                <option value="@c.Id">@c.Name</option>
            }
        }
    </select>
</div>

@if (SelectedCampsite is not null)
{
    <div class="mb-3">
        <div class="card p-2" style="max-width:480px;">
            <div style="display:flex; gap:10px;">
                @if (!string.IsNullOrEmpty(BgImageBase64))
                {
                    <img src="@BgImageBase64"
                         alt="Campsite image"
                         style="width:140px; height:90px; object-fit:cover; border-radius:8px;" />
                }
                <div>
                    <div class="fw-bold">@SelectedCampsite.Name</div>
                    <div class="text-muted" style="font-size:.9rem;">Viser @Units.Count enheder</div>
                </div>
            </div>
        </div>
    </div>
}

@if (SelectedCampsite is null)
{
    <p class="text-muted">
        Vælg en campingplads for at se kortet.
    </p>
}
else
{
    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
        <!-- MAP -->
        <div style="flex:1; min-width:320px;">
            <div id="mapContainer"
                 style="border:1px solid #bbb; border-radius:10px; overflow:hidden; width:800px; max-width:100%; height:600px; margin-bottom:1rem;">
                <svg id="campsiteSvg"
                     xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 800 600"
                     style="width:100%; height:100%;">
                    @if (!string.IsNullOrEmpty(BgImageBase64))
                    {
                        <image href="@BgImageBase64" x="0" y="0" width="800" height="600" />
                    }

                    @foreach (var u in Units)
                    {
                        var isSel = Selected?.Id == u.Id;
                        var stroke = isSel ? "stroke:#fff;stroke-width:3" : "stroke:#fff;stroke-width:2";

                        if (u.Type == "Cottage")
                        {
                            <g class="unit hut" data-id="@u.Id" transform="translate(@u.X,@u.Y)"
                               @onclick="() => OnUnitClicked(u)">
                                <rect x="-16" y="-12" width="32" height="24"
                                      style="fill:#28a745; @stroke" />
                                <path d="M -18 -12 L 0 -26 L 18 -12 Z"
                                      style="fill:#218838; @stroke" />
                            </g>
                        }
                        else
                        {
                            <g class="unit space" data-id="@u.Id" transform="translate(@u.X,@u.Y)"
                               @onclick="() => OnUnitClicked(u)">
                                <circle r="10" style="fill:#007bff; @stroke" />
                            </g>
                        }
                    }
                </svg>
            </div>
        </div>

        <!-- INFO PANEL -->
        <div style="width:360px; max-width:100%;">
            @if (Selected is not null)
            {
                <div class="map-infocard card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>@Selected.Name</strong>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="Clear">✕</button>
                    </div>

                    <div class="card-body">
                        <div><span class="label fw-bold">Type:</span> @(Selected.Type == "Cottage" ? "Hytte" : "Plads")</div>
                        <div><span class="label fw-bold">Position:</span> X=@Selected.X, Y=@Selected.Y</div>

                        @* COTTAGE DETALJER *@
                        @if (Selected.Type == "Cottage" && SelectedCottage is not null)
                        {
                            <hr />
                            <h5>Hytte detaljer</h5>
                            <div><span class="label fw-bold">Lokation:</span> @SelectedCottage.Location</div>
                            <div><span class="label fw-bold">Beskrivelse:</span> @SelectedCottage.Description</div>

                            <div class="mt-1">
                                <span class="label fw-bold">Faciliteter:</span>
                                @{
                                    var features = new List<string>();
                                    if (SelectedCottage.HasToilet) features.Add("Toilet");
                                    if (SelectedCottage.HasShower) features.Add("Bad");
                                    if (SelectedCottage.HasKitchen) features.Add("Køkken");
                                    if (SelectedCottage.HasHeating) features.Add("Varme");
                                    if (SelectedCottage.HasWiFi) features.Add("WiFi");
                                }
                                @(features.Count == 0 ? "Ingen særlige" : string.Join(", ", features))
                            </div>

                            <div class="mt-1">
                                <span class="label fw-bold">Pris pr. nat:</span>
                                @SelectedCottage.PricePerNight.ToString("C")
                            </div>
                            <div>
                                <span class="label fw-bold">Status:</span>
                                @(SelectedCottage.IsAvailable ? "Ledig" : "Optaget / ikke tilgængelig")
                            </div>

                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" @onclick="@(() => GoToCottageDetails(SelectedCottage.Id))">
                                    🔍 Gå til hyttedetaljer
                                </button>
                            </div>
                        }

                        @* SPACE DETALJER *@
                        @if (Selected.Type == "Space" && SelectedSpace is not null)
                        {
                            <hr />
                            <h5>Plads detaljer</h5>
                            <div><span class="label fw-bold">Lokation:</span> @SelectedSpace.Location</div>
                            <div><span class="label fw-bold">Beskrivelse:</span> @SelectedSpace.Description</div>
                            <div><span class="label fw-bold">El:</span> @(SelectedSpace.HasElectricity ? "Ja" : "Nej")</div>
                            <div class="mt-1">
                                <span class="label fw-bold">Afstande:</span>
                                Toilet: @SelectedSpace.MetersFromToilet m
                                @if (SelectedSpace.MetersFromPool is not null)
                                {
                                    <span>, Pool: @SelectedSpace.MetersFromPool m</span>
                                }
                                @if (SelectedSpace.MetersFromPlayground is not null)
                                {
                                    <span>, Legeplads: @SelectedSpace.MetersFromPlayground m</span>
                                }
                                @if (SelectedSpace.MetersFromOcean is not null)
                                {
                                    <span>, Hav: @SelectedSpace.MetersFromOcean m</span>
                                }
                            </div>
                            <div class="mt-1">
                                <span class="label fw-bold">Pris pr. nat:</span>
                                @SelectedSpace.PricePerNight.ToString("C")
                            </div>
                            <div>
                                <span class="label fw-bold">Status:</span>
                                @(SelectedSpace.IsAvailable ? "Ledig" : "Optaget / ikke tilgængelig")
                            </div>
                        }

                        <hr />
                        <h5>Bookinger</h5>

                        @if (IsLoadingDetails)
                        {
                            <div class="text-muted" style="font-size:.85rem;">Henter detaljer og bookinger...</div>
                        }
                        else if (SelectedBookings.Count == 0)
                        {
                            <div class="text-muted" style="font-size:.85rem;">Ingen bookinger fundet.</div>
                        }
                        else
                        {
                            <div class="booking-list" style="margin-top:.5rem;">
                                @foreach (var b in SelectedBookings)
                                {
                                    <div class="booking-row" style="margin-bottom:.5rem;">
                                        <div>
                                            <span class="label fw-bold">Periode:</span>
                                            @b.DateStart.ToString("dd-MM-yyyy")
                                            -
                                            @b.DateEnd.ToString("dd-MM-yyyy")
                                        </div>
                                        <div>
                                            <span class="label fw-bold">Gæst:</span>
                                            @b.UserName (@b.NumberOfPeople personer)
                                        </div>
                                        <div>
                                            <span class="label fw-bold">Totalpris:</span>
                                            @b.TotalPrice.ToString("C")
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <p class="text-muted mt-2">
                    Klik på en markør på kortet for at se detaljer og bookinger.
                </p>
            }
        </div>
    </div>
}

@code {
    public record UnitVm(Guid Id, string Name, string Type, int X, int Y);
    public record CampsiteVm(string Id, string Name, byte[]? Image);

    private List<CampsiteVm> Campsites = new();
    private string? SelectedCampsiteId;

    private CampsiteVm? SelectedCampsite =>
        Campsites.FirstOrDefault(c => c.Id == SelectedCampsiteId);

    private string? BgImageBase64 =>
        (SelectedCampsite?.Image?.Length > 0)
            ? $"data:image/png;base64,{Convert.ToBase64String(SelectedCampsite.Image)}"
            : null;

    private List<UnitVm> Units = new();
    private UnitVm? Selected;

    private CottageResponseDto? SelectedCottage;
    private SpaceResponseDto? SelectedSpace;
    private bool IsLoadingDetails;

    private sealed class BookingSummaryForUnitVm
    {
        public Guid Id { get; set; }
        public DateTime DateStart { get; set; }
        public DateTime DateEnd { get; set; }
        public string UserName { get; set; } = "";
        public int NumberOfPeople { get; set; }
        public decimal TotalPrice { get; set; }
    }

    private List<BookingSummaryForUnitVm> SelectedBookings { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCampsites();
    }

    private async Task LoadCampsites()
    {
        try
        {
            var data = await Http.GetFromJsonAsync<List<CampsiteResponseDto>>("api/campsite")
                       ?? new List<CampsiteResponseDto>();

            Campsites = data
                .Select(c => new CampsiteVm(
                    c.Id.ToString(),
                    c.Name,
                    c.Image))
                .ToList();
        }
        catch
        {
            Campsites = new();
        }
    }

    private async Task OnCampsiteChanged()
    {
        Selected = null;
        SelectedCottage = null;
        SelectedSpace = null;
        SelectedBookings = new();
        Units.Clear();

        if (string.IsNullOrEmpty(SelectedCampsiteId))
            return;

        var url = $"api/units?campsiteId={SelectedCampsiteId}";
        var data = await Http.GetFromJsonAsync<List<UnitDto>>(url) ?? new();
        Units = data.Select(d => new UnitVm(d.Id, d.Name, d.Type, d.X, d.Y)).ToList();

        await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
        StateHasChanged();
    }

    private async Task OnUnitClicked(UnitVm u)
    {
        Selected = u;
        SelectedCottage = null;
        SelectedSpace = null;
        SelectedBookings = new();
        IsLoadingDetails = true;
        StateHasChanged();

        try
        {
            if (u.Type == "Cottage")
            {
                SelectedCottage =
                    await Http.GetFromJsonAsync<CottageResponseDto>($"api/cottage/{u.Id}");
            }
            else if (u.Type == "Space")
            {
                SelectedSpace =
                    await Http.GetFromJsonAsync<SpaceResponseDto>($"api/space/{u.Id}");
            }

            var bookings =
                await Http.GetFromJsonAsync<List<BookingSummaryForUnitVm>>(
                    $"api/booking/by-unit/{u.Id}?type={u.Type}");

            SelectedBookings = bookings ?? new();
        }
        catch
        {
            // bare lad være tomt ved fejl
        }
        finally
        {
            IsLoadingDetails = false;
            StateHasChanged();
        }
    }

    private void Clear()
    {
        Selected = null;
        SelectedCottage = null;
        SelectedSpace = null;
        SelectedBookings = new();
        IsLoadingDetails = false;
    }

    private void GoToCottageDetails(Guid cottageId)
    {
        NavigationManager.NavigateTo($"/cottage/{cottageId}");
    }
}
