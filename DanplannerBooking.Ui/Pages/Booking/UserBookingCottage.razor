@page "/user-book-cottage/{cottageId:guid}"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@using DanplannerBooking.Application.Dtos.Cottage
@using DanplannerBooking.Application.Dtos.AddOn
@using DanplannerBooking.Application.Dtos.Booking
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<h3>Book a Cottage</h3>

@if (cottage == null || addOns == null)
{
 <p>Loading booking form...</p>
}
else
{
 <div class="row">
 <div class="col-md-8">
 <div class="card mb-4 shadow-sm">
 <div class="card-body">
 <h4>@cottage.Name</h4>
 <p><strong>Price Per Night:</strong> @cottage.PricePerNight.ToString("C")</p>
 <p><strong>Max Capacity:</strong>6 people</p>

 <EditForm Model="@newBooking" OnValidSubmit="SubmitBooking">
 <DataAnnotationsValidator />
 <ValidationSummary />

 <div>
 <label>Name of Booker</label>
 <InputText @bind-Value="newBooking.Name" class="form-control" />
 </div>

 <p>Unavailable ranges: @unavailableRanges.Count</p>

 <BookingDateRangePicker @bind-SelectedRange="BookingRange"
 UnavailableRanges="unavailableRanges" />

 <div class="mb-3 mt-3">
 <label>Number of People:</label>
 <InputNumber @bind-Value="newBooking.NumberOfPeople" class="form-control" />
 </div>

 <div class="mb-3">
 <label>Add-ons & Extras:</label>
 @foreach (var addon in addOns)
 {
 <div class="form-check">
 <input type="checkbox" class="form-check-input"
 @bind="addonSelections[addon.Id]" />
 <label class="form-check-label">
 <strong>@addon.Name</strong> - @addon.Description (@addon.Price.ToString("C"))
 </label>
 </div>
 }
 </div>

 <button type="submit" class="btn btn-success">Confirm Booking</button>
 </EditForm>

 <p class="mt-3 text-muted">
 • Free cancellation up to48 hours before check-in<br />
 • Check-in:2:00 PM –10:00 PM<br />
 • Check-out:11:00 AM
 </p>
 </div>
 </div>
 </div>

 <div class="col-md-4">
 <div class="card shadow-sm">
 <div class="card-body">
 <h5>Booking Summary</h5>
 <p><strong>Cottage:</strong> @cottage.Name</p>
 <p><strong>Guests:</strong> @newBooking.NumberOfPeople</p>
 <p><strong>Dates:</strong> @newBooking.DateStart.ToShortDateString() – @newBooking.DateEnd.ToShortDateString()</p>
 <p><strong>Add-ons:</strong></p>
 <ul>
 @foreach (var addon in addOns.Where(a => addonSelections.ContainsKey(a.Id) && addonSelections[a.Id]))
 {
 <li>@addon.Name (@addon.Price.ToString("C"))</li>
 }
 </ul>
 <p><strong>Total Price:</strong> @newBooking.TotalPrice.ToString("C")</p>

 @if (!string.IsNullOrWhiteSpace(error))
 {
 <p class="text-danger">@error</p>
 }
 </div>
 </div>
 </div>
 </div>
}

@code {
 [Parameter] public Guid cottageId { get; set; }

 private CottageResponseDto? cottage;
 private List<AddOnResponseDto>? addOns;
 private Dictionary<Guid, bool> addonSelections = new();
 private BookingDto newBooking = new();
 private List<BookingRangeDto> unavailableRanges = new();
 private string? error;

 // Wrapper around DateRange component
 private DateRange BookingRange
 {
 get => new DateRange(newBooking.DateStart, newBooking.DateEnd);
 set
 {
 newBooking.DateStart = value.Start ?? DateTime.Today;
 newBooking.DateEnd = value.End ?? DateTime.Today;
 }
 }

 protected override async Task OnInitializedAsync()
 {
 var authState = await AuthStateProvider.GetAuthenticationStateAsync();
 var user = authState.User;
 if (user?.Identity == null || !user.Identity.IsAuthenticated)
 {
 // redirect to login page and preserve return URL
 NavigationManager.NavigateTo($"/login?returnUrl={Uri.EscapeDataString(NavigationManager.Uri)}", true);
 return;
 }

 // Try to get user id from claims
 var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? user.FindFirst("sub")?.Value;
 if (!string.IsNullOrEmpty(idClaim) && Guid.TryParse(idClaim, out var userGuid))
 {
 newBooking.UserId = userGuid;
 }

 cottage = await Http.GetFromJsonAsync<CottageResponseDto>($"api/cottage/{cottageId}");
 addOns = await Http.GetFromJsonAsync<List<AddOnResponseDto>>("api/addon");
 unavailableRanges = await Http.GetFromJsonAsync<List<BookingRangeDto>>($"api/booking/unavailable/{cottageId}") ?? new List<BookingRangeDto>();

 foreach (var addon in addOns ?? Enumerable.Empty<AddOnResponseDto>())
 {
 addonSelections[addon.Id] = false;
 }

 newBooking.CottageId = cottageId;
 newBooking.Name = cottage?.Name ?? string.Empty;
 newBooking.DateStart = DateTime.Today;
 newBooking.DateEnd = DateTime.Today.AddDays(7);
 newBooking.NumberOfPeople =2;
 newBooking.TotalPrice = cottage?.PricePerNight ??0m;
 }

 private async Task SubmitBooking()
 {
 var selectedAddOns = (addOns ?? new List<AddOnResponseDto>())
 .Where(a => addonSelections.ContainsKey(a.Id) && addonSelections[a.Id])
 .ToList();

 var nights = (newBooking.DateEnd - newBooking.DateStart).Days;
 if (nights <=0) nights =1;

 var basePrice = (cottage?.PricePerNight ??0m) * nights;
 var addOnTotal = selectedAddOns.Sum(a => a.Price);
 newBooking.TotalPrice = basePrice + addOnTotal;

 var createDto = new BookingCreateCottageDto
 {
 UserId = newBooking.UserId,
 Name = newBooking.Name,
 NumberOfPeople = newBooking.NumberOfPeople,
 DateStart = newBooking.DateStart,
 DateEnd = newBooking.DateEnd,
 TotalPrice = newBooking.TotalPrice,
 CottageId = newBooking.CottageId,
 AddOnIds = selectedAddOns.Select(a => a.Id).ToList()
 };

 var response = await Http.PostAsJsonAsync("api/booking", createDto);
 if (response.IsSuccessStatusCode)
 {
 newBooking = new BookingDto();
 NavigationManager.NavigateTo("/");
 }
 else
 {
 var details = await response.Content.ReadAsStringAsync();
 error = $"Create failed ({(int)response.StatusCode}): {details}";
 }
 }
}
