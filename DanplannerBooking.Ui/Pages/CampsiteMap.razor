@page "/map"
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos

<h2>Pladskort</h2>
<p class="text-muted">Pan/zoom med musen. Klik på en plads eller hytte for detaljer.</p>

<div id="mapContainer" class="map-shell">
    <svg id="campsiteSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1336 768">
        <image href="images/campsite.jpg" x="0" y="0" width="1336" height="768" />

        @foreach (var u in Units)
        {
            var isSel = Selected?.Id == u.Id;
            var stroke = isSel ? "stroke:#fff;stroke-width:3" : "stroke:#fff;stroke-width:2";

            if (u.Type == "Cottage")
            {
                <g class="unit hut" data-id="@u.Id" transform="translate(@u.X,@u.Y)" @onclick="() => Select(u)">
                    <rect x="-16" y="-12" rx="5" ry="5" width="32" height="24" style="fill:rgba(130,76,14,.75); @stroke"></rect>
                    <path d="M-18 -12 L0 -26 L18 -12" style="fill:#6b3d0b; opacity:.9"></path>
                    <text y="-20" text-anchor="middle" fill="white" font-size="12">@u.Name</text>
                </g>
            }
            else
            {
                <g class="unit tent" data-id="@u.Id" transform="translate(@u.X,@u.Y)" @onclick="() => Select(u)">
                    <circle r="12" style="fill:rgba(0,160,70,.75); @stroke"></circle>
                    <text y="-20" text-anchor="middle" fill="white" font-size="12">@u.Name</text>
                </g>
            }
        }
    </svg>

    @if (Selected is not null)
    {
        <div class="map-infocard">
            <div class="hdr">
                <strong>@Selected.Name</strong>
                <button class="x" @onclick="Clear">✕</button>
            </div>
            <div class="body">
                <div><span class="label">Type:</span> @(Selected.Type == "Cottage" ? "Hytte" : "Plads")</div>
                <div><span class="label">Position:</span> X=@Selected.X, Y=@Selected.Y</div>
                <!-- TODO: bind availability/price when your API exposes it -->
            </div>
            <div class="actions">
                <button class="primary" @onclick="@(() => GoToBooking(Selected))">Book nu</button>
            </div>
        </div>
    }
</div>

@code {
    public record UnitVm(Guid Id, string Name, string Type, int X, int Y);

    private List<UnitVm> Units = new();
    private UnitVm? Selected;

    protected override async Task OnInitializedAsync()
    {
        var data = await Http.GetFromJsonAsync<List<UnitDto>>("api/units") ?? new();
        Units = data.Select(d => new UnitVm(d.Id, d.Name, d.Type, d.X, d.Y)).ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
    }

    private void Select(UnitVm u) => Selected = u;
    private void Clear() => Selected = null;

    private void GoToBooking(UnitVm u)
    {
        // Placeholder action. Change to your actual booking route.
        // For now: open an alert (or navigate).
        // Navigation example (if you have a booking page): NavigationManager.NavigateTo($"/booking/{u.Id}");
        _ = JS.InvokeVoidAsync("alert", $"Book {u.Name} ({(u.Type == "Cottage" ? "Hytte" : "Plads")})");
    }
}
