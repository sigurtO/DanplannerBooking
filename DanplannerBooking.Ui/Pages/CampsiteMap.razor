@page "/map"
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Net.Http.Json
@using DanplannerBooking.Application.Dtos

<h2>🏕️ Pladskort</h2>
<p class="text-muted">Vælg campingplads og se kortet med hytter og teltpladser.</p>

<div class="mb-3" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <label class="form-label mb-0">Vælg campingplads:</label>
    <select class="form-select" style="max-width:300px;" @bind="SelectedCampsiteId" @bind:after="OnCampsiteChanged">
        @if (Campsites.Count == 0)
        {
            <option value="">(indlæser...)</option>
        }
        else
        {
            <option value="">— vælg —</option>
            @foreach (var c in Campsites.DistinctBy(c => c.Id))
            {
                <option value="@c.Id">@c.Name</option>
            }
        }
    </select>
</div>

@if (SelectedCampsite is not null)
{
    <div class="mb-3">
        <div class="card p-2" style="max-width:480px;">
            <div style="display:flex; gap:10px;">
                <img src="@BgImageUrl" alt="@SelectedCampsite.Name" style="width:150px;height:90px;object-fit:cover;border-radius:6px;border:1px solid #ccc;" />
                <div>
                    <div class="fw-bold">@SelectedCampsite.Name</div>
                    <div class="text-muted" style="font-size:.9rem;">Viser @Units.Count enheder</div>
                    <div style="font-size:.85rem;"><code>@BgImageUrl</code></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mapContainer" class="map-shell" style="border:1px solid #ccc; border-radius:10px; overflow:hidden; width:100%; height:75vh;">
        <svg id="campsiteSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1336 768" style="width:100%; height:100%;">
            <image href="@BgImageUrl" x="0" y="0" width="1336" height="768" />
            @foreach (var u in Units)
            {
                var isSel = Selected?.Id == u.Id;
                var stroke = isSel ? "stroke:#fff;stroke-width:3" : "stroke:#fff;stroke-width:2";

                if (u.Type == "Cottage")
                {
                    <g class="unit hut" data-id="@u.Id" transform="translate(@u.X,@u.Y)" @onclick="() => Select(u)">
                        <rect x="-16" y="-12" rx="5" ry="5" width="32" height="24" style="fill:rgba(130,76,14,.75); @stroke"></rect>
                        <path d="M-18 -12 L0 -26 L18 -12" style="fill:#6b3d0b; opacity:.9"></path>
                        <text y="-20" text-anchor="middle" fill="white" font-size="12">@u.Name</text>
                    </g>
                }
                else
                {
                    <g class="unit tent" data-id="@u.Id" transform="translate(@u.X,@u.Y)" @onclick="() => Select(u)">
                        <circle r="12" style="fill:rgba(0,160,70,.75); @stroke"></circle>
                        <text y="-20" text-anchor="middle" fill="white" font-size="12">@u.Name</text>
                    </g>
                }
            }
        </svg>

        @if (Selected is not null)
        {
            <div class="map-infocard">
                <div class="hdr">
                    <strong>@Selected.Name</strong>
                    <button class="x" @onclick="Clear">✕</button>
                </div>
                <div class="body">
                    <div><span class="label">Type:</span> @(Selected.Type == "Cottage" ? "Hytte" : "Plads")</div>
                    <div><span class="label">Position:</span> X=@Selected.X, Y=@Selected.Y</div>
                </div>
                <div class="actions">
                    <button class="primary" @onclick="@(() => GoToBooking(Selected))">Book nu</button>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-muted">Vælg en campingplads for at se kortet.</p>
}

@code {
    public record UnitVm(Guid Id, string Name, string Type, int X, int Y);
    public record CampsiteVm(string Id, string Name, string ImageUrl);

    private List<CampsiteVm> Campsites = new();
    private string? SelectedCampsiteId;
    private CampsiteVm? SelectedCampsite => Campsites.FirstOrDefault(c => c.Id == SelectedCampsiteId);
    private string BgImageUrl => string.IsNullOrWhiteSpace(SelectedCampsite?.ImageUrl)
        ? "images/campsite.jpg"
        : SelectedCampsite!.ImageUrl;

    private List<UnitVm> Units = new();
    private UnitVm? Selected;

    protected override async Task OnInitializedAsync()
    {
        await LoadCampsites();
    }

    private async Task LoadCampsites()
    {
        try
        {
            Campsites = (await Http.GetFromJsonAsync<List<CampsiteVm>>("api/campsites")) ?? new();
        }
        catch
        {
            Campsites = new();
        }
    }

    private async Task OnCampsiteChanged()
    {
        Selected = null;
        Units.Clear();

        if (string.IsNullOrEmpty(SelectedCampsiteId))
            return;

        var url = $"api/units?campsiteId={SelectedCampsiteId}";
        var data = await Http.GetFromJsonAsync<List<UnitDto>>(url) ?? new();
        Units = data.Select(d => new UnitVm(d.Id, d.Name, d.Type, d.X, d.Y)).ToList();

        await JS.InvokeVoidAsync("CampsiteMap.initPanZoom", "#mapContainer", "#campsiteSvg");
        StateHasChanged();
    }

    private void Select(UnitVm u) => Selected = u;
    private void Clear() => Selected = null;

    private void GoToBooking(UnitVm u)
    {
        _ = JS.InvokeVoidAsync("alert", $"Book {u.Name} ({(u.Type == "Cottage" ? "Hytte" : "Plads")})");
    }
}
